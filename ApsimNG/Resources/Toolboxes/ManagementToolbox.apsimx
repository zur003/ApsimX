{
  "$type": "Models.Core.Simulations, Models",
  "ExplorerWidth": 483,
  "Version": 160,
  "Name": "Management toolbox",
  "ResourceName": null,
  "Children": [
    {
      "$type": "Models.Core.Folder, Models",
      "ShowInDocs": false,
      "GraphsPerPage": 6,
      "Name": "Weather",
      "ResourceName": null,
      "Children": [
        {
          "$type": "Models.Manager, Models",
          "Code": "using Newtonsoft.Json;\r\nusing APSIM.Shared.Utilities;\r\nusing Models.Interfaces;\r\nusing Models.Soils;\r\nusing Models.PMF;\r\nusing Models.Core;\r\nusing System.Xml.Serialization;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Soils.Nutrients;\r\nusing Models.Climate;\r\n\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        // - Links to APSIM models\r\n        [Link] Zone zone;\r\n        [Link] Clock clock;\r\n        [Link] Weather weather;\r\n        [Link] ISummary summary = null;\r\n\r\n        // - Paramters for this manager\r\n        [Description(\"Enable? Set to 'No' to completely disable this manager\")] public bool AllowControl { get; set; }\r\n\r\n        [Separator(\"General settings\")]\r\n        [Description(\"Start the climate controls beginning on date (dd/mmm/yyyy): \")] public DateTime EnableDate { get; set; }\r\n        [Description(\"Implement climate control only during part of the year?\")] public bool WithinYearControl { get; set; }\r\n        [Description(\"Within each year, the first day to start the climate controls is (dd-mmm)\")] public string ControlStart { get; set; }\r\n        [Description(\"Within each year, end last day of climate control is (dd-mmm)\")] public string ControlEnd { get; set; }\r\n\r\n        [Separator(\"Rainfall\")]\r\n        [Description(\"Rainfall multiplier (-): \")] public double RainfallMultiplier { get; set; }\r\n        [Description(\"Rainfall addition (mm): \")] public double RainfallAddition { get; set; }\r\n\r\n        [Separator(\"Radiation\")]\r\n        [Description(\"Radiation multiplier (-): \")] public double RadiationMultiplier { get; set; }\r\n        [Description(\"Radiation addition (MJ/m2): \")] public double RadiationAddition { get; set; }\r\n\r\n        [Separator(\"Minimum temperature\")]\r\n        [Description(\"Minimum temperature multiplier (-): \")] public double MinTMultiplier { get; set; }\r\n        [Description(\"Minimum temperature addition (C): \")] public double MinTAddition { get; set; }\r\n\r\n        [Separator(\"Maximum temperature\")]\r\n        [Description(\"Maximum temperature multiplier (-): \")] public double MaxTMultiplier { get; set; }\r\n        [Description(\"Maximum temperature addition (C): \")] public double MaxTAddition { get; set; }\r\n\r\n        [Separator(\"Wind speed\")]\r\n        [Description(\"Wind speed multiplier (-): \")] public double WindMultiplier { get; set; }\r\n        [Description(\"Wind speed addition (m/s): \")] public double WindAddition { get; set; }\r\n\r\n        [Separator(\"Vapour pressure\")]\r\n        [Description(\"Vapour pressure multiplier (-): \")] public double VPMultiplier { get; set; }\r\n        [Description(\"Vapour pressure addition (hPa): \")] public double VPAddition { get; set; }\r\n\r\n        [JsonIgnore] public bool DoControl { get; set; }\r\n        [JsonIgnore] public int DoControlInt { get; set; }\r\n\r\n        [EventSubscribe(\"PreparingNewWeatherData\")] private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n            // Check if this manager is enabled\r\n            if ((AllowControl) && (clock.Today >= EnableDate))\r\n            {\r\n                DoControl = true;\r\n                if (WithinYearControl)\r\n                    DoControl = DateUtilities.WithinDates(ControlStart, clock.Today, ControlEnd); \r\n            }\r\n\r\n            if (DoControl)\r\n                DoControlInt = 1;\r\n            else\r\n                DoControlInt = 0;\r\n\r\n            if (DoControl)\r\n            {\r\n                // do the weather alterations \r\n                weather.Rain = RainfallMultiplier * weather.Rain + RainfallAddition;\r\n                weather.Radn = RadiationMultiplier * weather.Radn + RadiationAddition;\r\n                weather.MinT = MinTMultiplier * weather.MinT + MinTAddition;\r\n                weather.MaxT = MaxTMultiplier * weather.MaxT + MaxTAddition;\r\n                weather.Wind = WindMultiplier * weather.Wind + WindAddition;\r\n                weather.VP = VPMultiplier * weather.VP + VPAddition;\r\n            }\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "AllowControl",
              "Value": "True"
            },
            {
              "Key": "EnableDate",
              "Value": "01/01/1972 00:00:00"
            },
            {
              "Key": "WithinYearControl",
              "Value": "False"
            },
            {
              "Key": "ControlStart",
              "Value": ""
            },
            {
              "Key": "ControlEnd",
              "Value": ""
            },
            {
              "Key": "RainfallMultiplier",
              "Value": "0.9"
            },
            {
              "Key": "RainfallAddition",
              "Value": "0"
            },
            {
              "Key": "RadiationMultiplier",
              "Value": "1"
            },
            {
              "Key": "RadiationAddition",
              "Value": "0"
            },
            {
              "Key": "MinTMultiplier",
              "Value": "1"
            },
            {
              "Key": "MinTAddition",
              "Value": "0"
            },
            {
              "Key": "MaxTMultiplier",
              "Value": "1"
            },
            {
              "Key": "MaxTAddition",
              "Value": "0"
            },
            {
              "Key": "WindMultiplier",
              "Value": "1"
            },
            {
              "Key": "WindAddition",
              "Value": "0"
            },
            {
              "Key": "VPMultiplier",
              "Value": "1"
            },
            {
              "Key": "VPAddition",
              "Value": "0"
            }
          ],
          "Name": "ClimateController",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\r\nusing System.Diagnostics;\r\nusing System.Collections.Generic;\r\nusing System.IO;\r\nusing System.Data;\r\nusing System.Linq;\r\nusing System;\r\nusing Models.Interfaces;\r\nusing Models.Core;\r\nusing Models.PMF;\r\nusing APSIM.Shared.Utilities;\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    [System.Xml.Serialization.XmlInclude(typeof(Model))]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock clock;\r\n        [Link] IWeather weather;\r\n        [Link] Simulation simulation;\r\n        \r\n        private DataTable data;\r\n        private List<DateTime> dates = new List<DateTime>();\r\n        private DateTime startDate;\r\n        private DateTime endDate;\r\n\r\n        [Description(\"Name of file containing weather data to patch:\")]\r\n        public string patchFileName { get; set; }\r\n\r\n        [Description(\"Date to start patching weather data (can be blank):\")]\r\n        public string date1 { get; set; }\r\n\r\n        [Description(\"Date to stop patching weather data: (can be blank)\")]\r\n        public string date2 { get; set; }\r\n\r\n        [Separator(\"Which data items should be patched\")]\r\n\r\n        [Description(\"Patch 'Rain'?\")] public bool PatchRain { get; set; }\r\n        \r\n        [Description(\"Patch 'MinT'?\")] public bool PatchMinT { get; set; }\r\n\r\n        [Description(\"Patch 'MaxT'?\")] public bool PatchMaxT { get; set; }\r\n\r\n        [Description(\"Patch 'Radn'?\")] public bool PatchRadn { get; set; }\r\n\r\n        [Description(\"Patch 'CO2'?\")] public bool PatchCO2 { get; set; }\r\n\r\n        [Description(\"Patch 'VP'?\")] public bool PatchVP { get; set; }\r\n        \r\n        [EventSubscribe(\"StartOfSimulation\")]\r\n        private void OnStartOfSimulation(object sender, EventArgs e)\r\n        {\r\n            // Ensure filename is relative to the directory where the .apsimx file is located.\r\n            string fullFileName = PathUtilities.GetAbsolutePath(patchFileName, simulation.FileName);\r\n        \r\n            // Read in data.\r\n            data = ApsimTextFile.ToTable(fullFileName);\r\n            foreach (DataRow row in data.Rows)\r\n                dates.Add(DataTableUtilities.GetDateFromRow(row));\r\n            \r\n            // Ensure startDate and endDate always have a value.\r\n            if (string.IsNullOrEmpty(date1))\r\n                startDate = clock.StartDate;\r\n            else\r\n                startDate = DateTime.Parse(date1);\r\n\r\n             if (string.IsNullOrEmpty(date2))\r\n                endDate = clock.EndDate;\r\n            else\r\n                endDate = DateTime.Parse(date2);\r\n\r\n        }\r\n\r\n        [EventSubscribe(\"PreparingNewWeatherData\")]\r\n        private void OnPreparingNewWeatherData(object sender, EventArgs e)\r\n        {\r\n            if (clock.Today >= startDate && clock.Today <= endDate)\r\n            {\r\n                // check to see if we have a row of data for today.\r\n                int rowIndex = dates.IndexOf(clock.Today);\r\n                if (rowIndex != -1)\r\n                {\r\n                    // Yes we do have data for today so patch the data.\r\n                    foreach (DataColumn column in data.Columns)\r\n                    {\r\n                        if (PatchRain && (column.ColumnName.Equals(\"Rain\", StringComparison.InvariantCultureIgnoreCase)))\r\n                            weather.Rain = Convert.ToDouble(data.Rows[rowIndex][column.ColumnName]);\r\n                        else if (PatchMinT && (column.ColumnName.Equals(\"MaxT\", StringComparison.InvariantCultureIgnoreCase)))\r\n                            weather.MaxT = Convert.ToDouble(data.Rows[rowIndex][column.ColumnName]);\r\n                        else if (PatchMaxT && (column.ColumnName.Equals(\"MinT\", StringComparison.InvariantCultureIgnoreCase)))\r\n                            weather.MinT = Convert.ToDouble(data.Rows[rowIndex][column.ColumnName]);\r\n                        else if ((PatchRadn && column.ColumnName.Equals(\"Radn\", StringComparison.InvariantCultureIgnoreCase)))\r\n                            weather.Radn = Convert.ToDouble(data.Rows[rowIndex][column.ColumnName]);\r\n                        else if (PatchCO2 && (column.ColumnName.Equals(\"CO2\", StringComparison.InvariantCultureIgnoreCase)))\r\n                            weather.CO2 = Convert.ToDouble(data.Rows[rowIndex][column.ColumnName]);\r\n                        else if (PatchVP && (column.ColumnName.Equals(\"VP\", StringComparison.InvariantCultureIgnoreCase)))\r\n                            weather.VP = Convert.ToDouble(data.Rows[rowIndex][column.ColumnName]);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "patchFileName",
              "Value": ""
            },
            {
              "Key": "date1",
              "Value": ""
            },
            {
              "Key": "date2",
              "Value": ""
            },
            {
              "Key": "PatchRain",
              "Value": "False"
            },
            {
              "Key": "PatchMinT",
              "Value": "False"
            },
            {
              "Key": "PatchMaxT",
              "Value": "False"
            },
            {
              "Key": "PatchRadn",
              "Value": "False"
            },
            {
              "Key": "PatchCO2",
              "Value": "False"
            },
            {
              "Key": "PatchVP",
              "Value": "False"
            }
          ],
          "Name": "PatchWeather",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        }
      ],
      "Enabled": true,
      "ReadOnly": false
    },
    {
      "$type": "Models.Core.Folder, Models",
      "ShowInDocs": false,
      "GraphsPerPage": 6,
      "Name": "Plant",
      "ResourceName": null,
      "Children": [
        {
          "$type": "Models.Manager, Models",
          "Code": "using APSIM.Shared.Utilities;\r\nusing Models.Utilities;\r\nusing Models.Soils;\r\nusing Models.PMF;\r\nusing Models.Core;\r\nusing System;\r\nusing System.Linq;\r\n\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock Clock;\r\n        [Link] Fertiliser Fertiliser;\r\n        [Link] Summary Summary;\r\n        [Link] Soil Soil;\r\n        \r\n        [Description(\"Crop\")]\r\n        public IPlant Crop { get; set; }\r\n\r\n        [Description(\"Sowing date (d-mmm)\")]\r\n        public string SowDate { get; set; }\r\n\r\n        [Display(Type = DisplayType.CultivarName)]\r\n        [Description(\"Cultivar to be sown\")]\r\n        public string CultivarName { get; set; }\r\n\r\n        [Description(\"Sowing depth (mm)\")]\r\n        public double SowingDepth { get; set; }\r\n\r\n        [Description(\"Row spacing (mm)\")]\r\n        public double RowSpacing { get; set; }\r\n\r\n        [Description(\"Plant population (/m2)\")]\r\n        public double Population { get; set; }\r\n\r\n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n            if (DateUtilities.WithinDates(SowDate, Clock.Today, SowDate))\r\n            {\r\n                Crop.Sow(population: Population, cultivar: CultivarName, depth: SowingDepth, rowSpacing: RowSpacing);    \r\n            }\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "Crop",
              "Value": ""
            },
            {
              "Key": "SowDate",
              "Value": "24-Jul"
            },
            {
              "Key": "CultivarName",
              "Value": "Amethyst"
            },
            {
              "Key": "SowingDepth",
              "Value": "50"
            },
            {
              "Key": "RowSpacing",
              "Value": "750"
            },
            {
              "Key": "Population",
              "Value": "6"
            }
          ],
          "Name": "Sow on a fixed date",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Interfaces;\r\nusing APSIM.Shared.Utilities;\r\nusing Models.Utilities;\r\nusing Models.Soils;\r\nusing Models.PMF;\r\nusing Models.Core;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Climate;\r\n\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] private Clock Clock;\r\n        [Link] private Fertiliser Fertiliser;\r\n        [Link] private Summary Summary;\r\n        [Link] private Soil Soil;\r\n        private Accumulator accumulatedRain;\r\n        [Link]\r\n        private ISoilWater waterBalance;\r\n        \r\n        [Description(\"Crop\")]\r\n        public IPlant Crop { get; set; }\r\n\r\n        [Description(\"Start of sowing window (d-mmm)\")]\r\n        public string StartDate { get; set; }\r\n\r\n        [Description(\"End of sowing window (d-mmm)\")]\r\n        public string EndDate { get; set; }\r\n\r\n        [Description(\"Minimum extractable soil water for sowing (mm)\")]\r\n        public double MinESW { get; set; }\r\n\r\n        [Description(\"Accumulated rainfall required for sowing (mm)\")]\r\n        public double MinRain { get; set; }\r\n\r\n        [Description(\"Duration of rainfall accumulation (d)\")]\r\n        public int RainDays { get; set; }\r\n\r\n        [Display(Type = DisplayType.CultivarName)]\r\n        [Description(\"Cultivar to be sown\")]\r\n        public string CultivarName { get; set; }\r\n\r\n        [Description(\"Sowing depth (mm)\")]\r\n        public double SowingDepth { get; set; }\r\n\r\n        [Description(\"Row spacing (mm)\")]\r\n        public double RowSpacing { get; set; }\r\n\r\n        [Description(\"Plant population (/m2)\")]\r\n        public double Population { get; set; }\r\n        \r\n        \r\n        [EventSubscribe(\"StartOfSimulation\")]\r\n        private void OnSimulationCommencing(object sender, EventArgs e)\r\n        {\r\n            accumulatedRain = new Accumulator(this, \"[Weather].Rain\", RainDays);\r\n        }\r\n\r\n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n            accumulatedRain.Update();\r\n            \r\n            if (DateUtilities.WithinDates(StartDate, Clock.Today, EndDate) &&\r\n                !Crop.IsAlive &&\r\n                MathUtilities.Sum(waterBalance.ESW) > MinESW &&\r\n                accumulatedRain.Sum > MinRain)\r\n            {\r\n                Crop.Sow(population: Population, cultivar: CultivarName, depth: SowingDepth, rowSpacing: RowSpacing);    \r\n            }\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "Crop",
              "Value": ""
            },
            {
              "Key": "StartDate",
              "Value": "1-nov"
            },
            {
              "Key": "EndDate",
              "Value": "10-jan"
            },
            {
              "Key": "MinESW",
              "Value": "100"
            },
            {
              "Key": "MinRain",
              "Value": "25"
            },
            {
              "Key": "RainDays",
              "Value": "7"
            },
            {
              "Key": "CultivarName",
              "Value": "Dekalb_XL82"
            },
            {
              "Key": "SowingDepth",
              "Value": "30"
            },
            {
              "Key": "RowSpacing",
              "Value": "750"
            },
            {
              "Key": "Population",
              "Value": "6"
            }
          ],
          "Name": "Sow using a variable rule",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using APSIM.Shared.Utilities;\r\nusing Models.Utilities;\r\nusing Models.Soils;\r\nusing Models.PMF;\r\nusing Models.Core;\r\nusing System;\r\nusing System.Linq;\r\n\r\nnamespace Models\r\n{\r\n    [Serializable] \r\n    public class Script : Model\r\n    {\r\n        [Description(\"Crop\")]\r\n        public IPlant Crop { get; set; }\r\n        \r\n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n            if (Crop.IsReadyForHarvesting)\r\n            {\r\n                Crop.Harvest();\r\n                Crop.EndCrop();\r\n            }\r\n        }\r\n    }\r\n}\r\n       \r\n",
          "Parameters": [
            {
              "Key": "Crop",
              "Value": ""
            }
          ],
          "Name": "Harvesting",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Core;\r\nusing Models.PMF;\r\nusing APSIM.Shared.Utilities;\r\nusing Models.Surface;\r\n\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock Clock;\r\n        [Link] SurfaceOrganicMatter SOM;\r\n        \r\n        [Description(\"Tillage Date\")]\r\n        public string TillageDate { get; set; }\r\n        \r\n        [Description(\"Fraction of Residues To Incorporate (0-1)\")]\r\n        public double Fraction { get; set; }\r\n\r\n        [Description(\"Depth of Tillage (mm)\")]\r\n        public double Depth { get; set; }\r\n\r\n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n            if (DateUtilities.WithinDates(TillageDate, Clock.Today, TillageDate))\r\n                SOM.Incorporate(Fraction, Depth);\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "TillageDate",
              "Value": "1-jul"
            },
            {
              "Key": "Fraction",
              "Value": "0.5"
            },
            {
              "Key": "Depth",
              "Value": "0"
            }
          ],
          "Name": "Tillage on a fixed date",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "\r\nusing Models.Soils;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Core;\r\nusing Models.PMF;\r\nusing APSIM.Shared.Utilities;\r\n\r\nnamespace Models\r\n{\r\n    [Serializable] \r\n    [System.Xml.Serialization.XmlInclude(typeof(Model))]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock Clock;\r\n        [Link] Fertiliser Fertiliser;\r\n\r\n        public double TimeSincePlanting {get; set;}\r\n\r\n        [Description(\"The tree to manage\")]\r\n        public Plant Plant { get; set; }\r\n\r\n        [Description(\"Spacing (m) between plants within rows\")]\r\n        public double RowSpace { get; set; }\r\n\r\n        [Description(\"Spacing (m) between rows\")]\r\n        public double RowWidth { get; set; }\r\n\r\n        [Description(\"Cultivar\")]\r\n        [Display(Type=DisplayType.CultivarName)]\r\n        public string CultivarName { get; set; }\r\n\r\n        [Description(\"Planting Date (dd-mmm)\")]\r\n        public String PlantingDate { get; set; }\r\n\r\n        [Description(\"Harvest Age (years)\")]\r\n        public double HarvestAge { get; set; }\r\n\r\n        [Description(\"Amount of fertiliser N to be applied at planting (kg N/ha)\")]\r\n        public double FertAmount { get; set; }\r\n\r\n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n            double PlantPopulation = 1 / (RowWidth * RowSpace);\r\n            double RowWidthmm = RowWidth * 1000;\r\n\r\n            if (DateUtilities.WithinDates(PlantingDate, Clock.Today, PlantingDate) && !Plant.IsAlive)\r\n            {\r\n                Plant.Sow(population: PlantPopulation, \r\n                    cultivar: CultivarName, \r\n                    depth: 100, \r\n                    rowSpacing: RowWidthmm);\r\n                TimeSincePlanting = 0;\r\n                Fertiliser.Apply(Amount: FertAmount, Type: Fertiliser.Types.NO3N);\r\n            }\r\n\r\n            if (TimeSincePlanting > HarvestAge && Plant.IsAlive)\r\n            {\r\n               Plant.Harvest();\r\n               Plant.EndCrop();         \r\n               TimeSincePlanting = 0;  \r\n            }\r\n\r\n            TimeSincePlanting += 1.0/365.0;\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "Plant",
              "Value": ""
            },
            {
              "Key": "RowSpace",
              "Value": "3"
            },
            {
              "Key": "RowWidth",
              "Value": "3"
            },
            {
              "Key": "CultivarName",
              "Value": "grandisCoffsHarbour"
            },
            {
              "Key": "PlantingDate",
              "Value": "1-aug"
            },
            {
              "Key": "HarvestAge",
              "Value": "7"
            },
            {
              "Key": "FertAmount",
              "Value": "100"
            }
          ],
          "Name": "TreeManagement",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        }
      ],
      "Enabled": true,
      "ReadOnly": false
    },
    {
      "$type": "Models.Core.Folder, Models",
      "ShowInDocs": false,
      "GraphsPerPage": 6,
      "Name": "Fertilise",
      "ResourceName": null,
      "Children": [
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Core;\r\nusing Models.PMF;\r\nusing APSIM.Shared.Utilities;\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock Clock;\r\n        [Link] Fertiliser Fertiliser;\r\n        \r\n        [Separator(\"A component to apply fertiliser on one or more dates on every year of the simulation\")]\r\n\r\n        [Description(\"Type of fertiliser to apply? \")] \r\n        public Fertiliser.Types FertiliserType { get; set; }\r\n\r\n        [Description(\"Enter the fertilisation dates as dd-mmm with comma separation (any year information entered will be ignored): \")] \r\n        public string[] FertiliserDates { get; set; } \r\n\r\n        [Description(\"Amount of fertiliser to be applied (kg /ha)\")] \r\n        public double Amount { get; set; }\r\n\r\n        [Description(\"Is the above amount to be applied each time? (yes/ticked)? Or is it the total annual amount across all dates (no/unticked)\")] \r\n        public bool AmountType { get; set; }\r\n        \r\n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n            foreach (string ddMMM in FertiliserDates)\r\n            {\r\n                if (DateUtilities.DatesEqual(ddMMM, Clock.Today))\r\n                {\r\n                    if (AmountType)\r\n                        Fertiliser.Apply(Amount: Amount, Type: FertiliserType);\r\n                    else\r\n                        Fertiliser.Apply(Amount: Amount / FertiliserDates.Length, Type: FertiliserType);\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "FertiliserType",
              "Value": "NO3N"
            },
            {
              "Key": "FertiliserDates",
              "Value": "24-apr"
            },
            {
              "Key": "Amount",
              "Value": "160"
            },
            {
              "Key": "AmountType",
              "Value": "False"
            }
          ],
          "Name": "Fertilise on fixed dates",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Interfaces;\r\nusing System.Linq;\r\nusing APSIM.Shared.Utilities;\r\nusing Models.PMF;\r\nusing Models.Soils;\r\nusing Models.Core;\r\nusing System;\r\nusing Models.Soils.Nutrients;\r\n\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] private Clock clock;\r\n        [Link] private Fertiliser fertiliser;\r\n        [Link] private ISummary summary;\r\n        [Link] private Soil soil;\r\n        private Nutrient nutrient;\r\n        private SoilNitrogen soilN;\r\n        [Link]\r\n        private IPhysical soilPhysical;\r\n\r\n\r\n        [Separator(\"Fertiliser will be applied on the date(s) below\")]\r\n        [Description(\"Apply fertiliser on the same day(s) each year? If no, then must include the year of appliaction below\")]\r\n        public bool EachYear { get; set; }\r\n\r\n        [Description(\"Dates for one or more fertiliser applications (dd-mmm or dd-mmm-yyyy) as a list with a comma between dates\")]\r\n        public string[] Dates { get; set; }\r\n\r\n        [Separator(\"Test for the mineral N in the soil and don't apply the fertiliser if greater than X kgN/ha is stored in the soil above a depth of Y mm\")]\r\n        [Description(\"Use a critical soil mineral N to prevent application above a threshold?\")]\r\n        public bool UseCritNThreshold { get; set; }\r\n\r\n        [Description(\"Don't add fertiliser if N in the soil to the depth below exceeds (kg/ha)\")]\r\n        public double CritNThreshold { get; set; }\r\n\r\n        [Description(\"Depth to which the amount of N in the soil should be calculated (mm)\")]\r\n        public double CritNDepth { get; set; }\r\n\r\n        [Separator(\"Fertiliser application details\")]\r\n        [Description(\"Depth at which to apply the fertiliser (mm)\")]\r\n        public double Depth { get; set; }\r\n\r\n        [Description(\"Amount of fertiliser to apply (kg N /ha) per application\")]\r\n        public double Amount { get; set; }\r\n\r\n        [Description(\"Fertiliser type - select from the list\")]\r\n        public Fertiliser.Types FertiliserType { get; set; }\r\n\r\n\r\n        [EventSubscribe(\"StartOfSimulation\")]\r\n        private void FindSoilNOrNutrient(object sender, EventArgs e)\r\n        {\r\n            nutrient = this.FindInScope<Nutrient>() as Nutrient;\r\n            soilN = this.FindInScope<SoilNitrogen>() as SoilNitrogen;\r\n\r\n            if (nutrient == null && soilN == null)\r\n                throw new Exception(string.Format(\"Error in script {0}: Unable to find nutrient or soilN.\", Name));\r\n        }\r\n\r\n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n            if (OnApplicationDate())\r\n            {\r\n                if (NContentBelowThreshold())\r\n                    fertiliser.Apply(Amount, FertiliserType, Depth);\r\n                else\r\n                    summary.WriteMessage(this, \"Skipping fertiliser application due to soil mineral N content being above critical threshold.\", MessageType.Diagnostic);\r\n            }\r\n        }\r\n\r\n        /// <summary>Checks if today's date is one of the specified fertiliser application dates.</summary>\r\n        private bool OnApplicationDate()\r\n        {\r\n            if (EachYear)\r\n                return Dates.Any(d => DateUtilities.DatesEqual(d, clock.Today));\r\n            \r\n            DateTime[] dates = Dates.Select(d => DateTime.ParseExact(d, \"d-MMM-yyyy\", null)).ToArray();\r\n            return dates.Any(d => SameDate(d, clock.Today));\r\n        }\r\n\r\n        /// <summary>Checks if N content in soil is below critical threshold.</summary>\r\n        private bool NContentBelowThreshold()\r\n        {\r\n            if (!UseCritNThreshold)\r\n                return true;\r\n            \r\n            double[] weights = GetLayerWeights();\r\n            double cumSoilN = 0;\r\n\r\n            for (int i = 0; i < soilPhysical.Thickness.Length; i++)\r\n            {\r\n                if (nutrient != null)\r\n                    cumSoilN += weights[i] * nutrient.MineralN[i];\r\n                else if (soilN != null)\r\n                    cumSoilN += weights[i] * soilN.mineral_n[i];\r\n            }\r\n\r\n            return cumSoilN <= CritNThreshold;\r\n        }\r\n\r\n        private double[] GetLayerWeights()\r\n        {\r\n            double[] weights = new double[soilPhysical.Thickness.Length];\r\n            double cumDepth = 0;\r\n\r\n            for (int i = 0; i < soilPhysical.Thickness.Length; i++)\r\n            {\r\n                cumDepth += soilPhysical.Thickness[i];\r\n                if (cumDepth < CritNDepth)\r\n                    weights[i] = 1;\r\n                else if (cumDepth - soilPhysical.Thickness[i] <= CritNDepth)\r\n                    weights[i] = (CritNDepth - (cumDepth - soilPhysical.Thickness[i])) / soilPhysical.Thickness[i];\r\n                else\r\n                    weights[i] = 0;\r\n            }\r\n\r\n            return weights;\r\n        }\r\n\r\n        private bool SameDate(DateTime d1, DateTime d2)\r\n        {\r\n            return d1.Year == d2.Year && d1.DayOfYear == d2.DayOfYear;\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "EachYear",
              "Value": "True"
            },
            {
              "Key": "Dates",
              "Value": "30-nov, 15-apr"
            },
            {
              "Key": "UseCritNThreshold",
              "Value": "False"
            },
            {
              "Key": "CritNThreshold",
              "Value": "50"
            },
            {
              "Key": "CritNDepth",
              "Value": "75"
            },
            {
              "Key": "Depth",
              "Value": "50"
            },
            {
              "Key": "Amount",
              "Value": "25"
            },
            {
              "Key": "FertiliserType",
              "Value": "UreaN"
            }
          ],
          "Name": "Fertilise on fixed dates (advanced version)",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Core;\r\nusing Models.PMF;\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock Clock;\r\n        [Link] Fertiliser Fertiliser;\r\n        \r\n        [Description(\"Crop to be fertilised\")]\r\n        public IPlant Crop { get; set; }\r\n\r\n        [Description(\"Type of fertiliser to apply? \")] \r\n        public Fertiliser.Types FertiliserType { get; set; }\r\n    \r\n        [Description(\"Amount of fertiliser to be applied (kg/ha)\")]\r\n        public double Amount { get; set; }\r\n        \r\n        [EventSubscribe(\"Sowing\")]\r\n        private void OnSowing(object sender, EventArgs e)\r\n        {\r\n            Model crop = sender as Model;\r\n            if (Crop != null && crop.Name.ToLower() == (Crop as IModel).Name.ToLower())\r\n                Fertiliser.Apply(Amount: Amount, Type: FertiliserType);\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "Crop",
              "Value": ""
            },
            {
              "Key": "FertiliserType",
              "Value": "UreaN"
            },
            {
              "Key": "Amount",
              "Value": "160"
            }
          ],
          "Name": "Fertilise at sowing",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Core;\r\nusing Models.PMF;\r\nnamespace Models\r\n{\r\n    [Serializable] \r\n    public class Script : Model\r\n    {\r\n        [Link] Clock Clock;\r\n        [Link] Fertiliser Fertiliser;\r\n        [Link] Summary Summary;\r\n        [Link] Plant Wheat;\r\n \r\n        private bool hasFertilised = false;\r\n\r\n        [Description(\"Fertilise once crop reaches stage:\")]\r\n        public double Stage { get; set; }\r\n\r\n        [Description(\"Type of fertiliser to apply? \")] \r\n        public Fertiliser.Types FertiliserType { get; set; }\r\n\r\n        [Description(\"Amount of fertiliser to be applied (kg/ha)\")] \r\n        public double Amount { get; set; }\r\n     \r\n        [EventSubscribe(\"DoManagement\")] \r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        { \r\n            double zadok = (double)Wheat.FindByPath(\"Phenology.Zadok.Stage\").Value; \r\n \r\n            if (zadok >= Stage && !hasFertilised)\r\n            { \r\n                Summary.WriteMessage(this, \"Fertilising!!\", MessageType.Diagnostic); \r\n                Fertiliser.Apply(Amount: Amount, Type: FertiliserType);\r\n                hasFertilised = true; \r\n            } \r\n        }\r\n\r\n        [EventSubscribe(\"Sowing\")]\r\n        private void OnSowing(object sender, EventArgs e)\r\n        {\r\n            hasFertilised = false;\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "Stage",
              "Value": "30"
            },
            {
              "Key": "FertiliserType",
              "Value": "UreaN"
            },
            {
              "Key": "Amount",
              "Value": "40"
            }
          ],
          "Name": "Fertilise on Zadok stage",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\r\nusing APSIM.Shared.Utilities;\r\nusing Models.Soils.Nutrients;\r\nusing Models.PMF;\r\nusing Models.Core;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Soils.Nutrients;\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock Clock;\r\n        [Link] Fertiliser Fertiliser;\r\n        [Link(ByName=true)] Solute NO3;\r\n\r\n        [Description(\"Type of fertiliser to apply? \")] \r\n        public Fertiliser.Types FertiliserType { get; set; }\r\n    \r\n        [Description(\"Threshold amount of NO3 to topup to (kg/ha)\")]\r\n        public double Threshold { get; set;}\r\n        \r\n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n            double Amount = Threshold - MathUtilities.Sum(NO3.kgha);\r\n            Fertiliser.Apply(Amount: Amount, Type: FertiliserType);\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "FertiliserType",
              "Value": "NO3N"
            },
            {
              "Key": "Threshold",
              "Value": "200"
            }
          ],
          "Name": "Fertilise topup",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\nusing System;\nusing Models.Functions;\nusing Models.Core;\nusing Models.PMF;\nusing APSIM.Shared.Utilities;\nusing System.Diagnostics;\nnamespace Models\n{\n    [Serializable]\n    public class Script : Model\n    {\n        [Link] Clock clock;\n        [Link] Fertiliser fertiliser;\n        [Link] Zone zone;\n        \n        [Separator(\"A model to apply fertiliser days after a variable reaches a threshold\")]\n        [Separator(\"Trigger to fertilse on\")]\n                 \n        [Description(\"Name of APSIM variable\")] \n        public string VariableName { get; set; } \n                \n        [Description(\"Threshold value to trigger fertilise\")]       \n        public double TriggerValue { get; set; }\n        \n        [Description(\"Number of days to wait after trigger\")] \n        public int NumDaysToWait { get; set; }  \n               \n        [Separator(\"Amount and type to fertilise\")]\n                 \n        [Description(\"Amount of fertiliser to be applied (kg /ha)\")] \n        public double Amount { get; set; }  \n               \n        [Description(\"Type of fertiliser to apply? \")] \n        public Fertiliser.Types FertiliserType { get; set; }   \n          \n        private DateTime FertiliseDate;  \n               \n        [EventSubscribe(\"StartOfSimulation\")]\n        private void OnStartOfSimulation(object sender, EventArgs e)\n\t\t{\n\t\t}               \n               \n        [EventSubscribe(\"DoManagementCalculations\")]\n        private void OnDoManagementCalculations(object sender, EventArgs e)\n        {\n        \tvar obj = zone.Get(VariableName);\n            double value;\n            if (obj is double)\n            \tvalue = (double) obj;\n            else if (obj is IFunction f)\n            \tvalue = f.Value();\n            else\n            \tthrow new Exception($\"Unknown type of variable: {VariableName}\");\n            \t \n            if (MathUtilities.FloatsAreEqual(value, TriggerValue, 0.1))\n                FertiliseDate = clock.Today.AddDays(NumDaysToWait);\n\n            if (clock.Today == FertiliseDate)\n               fertiliser.Apply(Amount: Amount, Type: FertiliserType);\n        }\n    }\n}",
          "Parameters": [
            {
              "Key": "VariableName",
              "Value": "[Wheat].Phenology.Zadok.Stage"
            },
            {
              "Key": "TriggerValue",
              "Value": "11"
            },
            {
              "Key": "NumDaysToWait",
              "Value": "10"
            },
            {
              "Key": "Amount",
              "Value": "30"
            },
            {
              "Key": "FertiliserType",
              "Value": "Urea"
            }
          ],
          "Name": "Fertilise when variable reaches threshold",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\nusing System;\nusing Models.Functions;\nusing Models.Core;\nusing Models.PMF;\nusing APSIM.Shared.Utilities;\nusing System.Diagnostics;\nnamespace Models\n{\n    [Serializable]\n    public class Script : Model\n    {\n        [Link] Clock clock;\n        [Link] Fertiliser fertiliser;\n        [Link] Zone zone;\n        [Link] IEvent events = null;\n        \n        [Separator(\"A model to apply fertiliser days after a variable reaches a threshold\")]\n        [Separator(\"Trigger to fertilse on\")]\n                 \n        [Description(\"Name of APSIM event\")] \n        public string EventName { get; set; } \n        \n        [Description(\"Number of days to wait after trigger\")] \n        public int NumDaysToWait { get; set; }  \n               \n        [Separator(\"Amount and type to fertilise\")]\n                 \n        [Description(\"Amount of fertiliser to be applied (kg /ha)\")] \n        public double Amount { get; set; }  \n               \n        [Description(\"Type of fertiliser to apply? \")] \n        public Fertiliser.Types FertiliserType { get; set; }   \n          \n        private DateTime FertiliseDate;  \n               \n        [EventSubscribe(\"StartOfSimulation\")]\n        private void OnStartOfSimulation(object sender, EventArgs e)\n\t\t{\n\t\t\tevents.Subscribe(EventName, OnEvent);\n\t\t}\n\t\t\n\t\tprivate void OnEvent(object sender, EventArgs e)\n\t\t{\n\t\t\tFertiliseDate = clock.Today.AddDays(NumDaysToWait);\n\t\t}               \n               \n        [EventSubscribe(\"DoManagementCalculations\")]\n        private void OnDoManagementCalculations(object sender, EventArgs e)\n        {\n            if (clock.Today == FertiliseDate)\n               fertiliser.Apply(Amount: Amount, Type: FertiliserType);\n        }\n    }\n}",
          "Parameters": [
            {
              "Key": "NumDaysToWait",
              "Value": "10"
            },
            {
              "Key": "Amount",
              "Value": "30"
            },
            {
              "Key": "FertiliserType",
              "Value": "Urea"
            },
            {
              "Key": "EventName",
              "Value": "[Wheat].Phenology.PlantEmerged"
            }
          ],
          "Name": "Fertilise on event",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        }
      ],
      "Enabled": true,
      "ReadOnly": false
    },
    {
      "$type": "Models.Core.Folder, Models",
      "ShowInDocs": false,
      "GraphsPerPage": 6,
      "Name": "Irrigate",
      "ResourceName": null,
      "Children": [
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Core;\r\nusing Models.PMF;\r\nusing APSIM.Shared.Utilities;\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock Clock;\r\n        [Link] Irrigation Irrigation;\r\n        \r\n        [Separator(\"A component to apply irrigation on one or more dates on every year of the simulation\")]\r\n\r\n        [Description(\"Enter the irrigation dates as dd-mmm with comma separation (any year information entered will be ignored)\")] \r\n        public string[] IrrigateDates { get; set; }\r\n        \r\n        [Description(\"Amount of irrigation to be applied (mm)\")] \r\n        public double Amount { get; set; }\r\n        \r\n        [Description(\"Depth in the soil to apply the  irrigation (mm)\")] \r\n        public double Depth { get; set; }\r\n        \r\n        [Description(\"Efficiency of irrigation (0-1)\")] \r\n        public double Efficiency { get; set; }\r\n        \r\n        [Description(\"Will the irrigation runoff?\")] \r\n        public bool WillRunoff { get; set; }\r\n        \r\n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n            foreach (string ddMMM in IrrigateDates)\r\n            {\r\n                if (DateUtilities.DatesEqual(ddMMM, Clock.Today))\r\n                    Irrigation.Apply(amount: Amount, depth: Depth, efficiency: Efficiency, willRunoff: WillRunoff);\r\n            }\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "IrrigateDates",
              "Value": "24-jan"
            },
            {
              "Key": "Amount",
              "Value": "30"
            },
            {
              "Key": "Depth",
              "Value": "0"
            },
            {
              "Key": "Efficiency",
              "Value": "1"
            },
            {
              "Key": "WillRunoff",
              "Value": "False"
            }
          ],
          "Name": "Irrigate on fixed dates",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Newtonsoft.Json;\r\nusing APSIM.Shared.Utilities;\r\nusing System.Xml.Serialization;\r\nusing Models.Soils;\r\nusing Models.PMF;\r\nusing Models.Core;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Interfaces;\r\n\r\n\r\n\r\n        \r\nnamespace Models\r\n{\r\n    [Serializable] \r\n    [System.Xml.Serialization.XmlInclude(typeof(Model))]\r\n    public class Script : Model\r\n    {\r\n        [Link] private ISummary summary;\r\n        [Link] private Irrigation Irrigation;\r\n        [Link] private Clock Clock;\r\n        [Link] private Soil Soil;\r\n        [Link(IsOptional = true)] private IPlant existingCrop;\r\n        private DateTime StartDate;\r\n        private DateTime EndDate;\r\n        private double TopDUL;\r\n        private double TopLL;\r\n        private int nLayers;\r\n        [Link]\r\n        private IPhysical soilPhysical;\r\n        [Link]\r\n        private ISoilWater waterBalance;\r\n        //Communication to other modules\r\n       \r\n        //User inputs from properties tab\r\n        [Description(\"Turn irrigation on?\")]\r\n        public bool allowIrrigation { get; set; }\r\n        [Description(\"Start of irrigation season (dd-MMM)\")]\r\n        public string seasonStart { get; set; }\r\n        [Description(\"End of irrigation season (dd-MMM)\")]\r\n        public string seasonEnd { get; set; }\r\n        [Description(\"Season allocation (mm)\")]\r\n        public double seasonsAllocation { get; set; }\r\n        [Description(\"Deficit to trigger irrigation (% PAWC)\")]\r\n        public double triggerDeficit { get; set; }\r\n        [Description(\"Deficit to stop irrigaton (% PAWC)\")]\r\n        public double targetDeficit { get; set; }\r\n        [Description(\"Minimum days for irrigation to return\")]\r\n        public double returndays { get; set; }\r\n        [Description(\"Maximum irrigation application (mm/day)\")]\r\n        public double maximumAmount { get; set; }\r\n        [Description(\"Depth to calculate PAWC (mm)\")]\r\n        public double depthPAWC { get; set; }\r\n\r\n        //Class members\r\n        [JsonIgnore] public double TopSWdeficit { get; set; }\r\n        [JsonIgnore] public double TopSWC { get; set; }\r\n        [JsonIgnore] public double DaysSinceIrrigation { get; set; }\r\n        [JsonIgnore] public double AmountToApply { get; set; }\r\n        [JsonIgnore] public double SeasonAppliedAmount { get; set; }\r\n        \r\n        private bool IrrigationIsAllowed { get; set; }\r\n        private bool SeasonIsOpen { get; set; }\r\n        private bool CropIsActive { get; set; }\r\n        private bool IrrigatorIsAvailable { get; set; }\r\n        private bool SoilIsDry { get; set; }\r\n\r\n    \r\n        //Calculate static soil variables\r\n        [EventSubscribe(\"StartOfSimulation\")]\r\n        private void OnStartOfSimulation(object sender, EventArgs e)\r\n        {   \r\n            //Set the season dates\r\n            StartDate = DateTime.Parse(seasonStart + \"-\" + Clock.Today.Year.ToString());\r\n            EndDate = DateTime.Parse(seasonEnd + \"-\" + Clock.Today.Year.ToString());\r\n            \r\n            //Can we irrigate at all?\r\n            IrrigationIsAllowed = false; \r\n            if (allowIrrigation)\r\n                IrrigationIsAllowed = true; \r\n\r\n            //Calculate soil water variables\r\n            double depthFromSurface = 0.0;\r\n            double fracLayer = 0.0;\r\n            nLayers = soilPhysical.Thickness.Length;\r\n            for (int layer = 0; layer < nLayers; layer++)\r\n            {\r\n                fracLayer = Math.Min(1.0, (depthPAWC - depthFromSurface) / soilPhysical.Thickness[layer]);\r\n                TopLL += soilPhysical.LL15mm[layer] * fracLayer;\r\n                TopDUL += soilPhysical.DULmm[layer] * fracLayer;\r\n                depthFromSurface += soilPhysical.Thickness[layer];\r\n                if (depthFromSurface >= depthPAWC)\r\n                    layer = nLayers;\r\n            }\r\n        }\r\n             \r\n        //Determine daily requirement for irrigation\r\n        [EventSubscribe(\"StartOfDay\")]\r\n        private void OnStartOfDay(object sender, EventArgs e)\r\n        {\r\n            //Can we irrigate today?          \r\n            SeasonIsOpen = isBetween(Clock.Today, StartDate, EndDate);\r\n            if (!SeasonIsOpen)\r\n                SeasonAppliedAmount = 0;\r\n\r\n            //Is there a crop in the ground that needs irrigation?\r\n            CropIsActive = false;\r\n            if ((existingCrop != null) && (existingCrop.IsAlive))\r\n                CropIsActive = true;\r\n            //if ((existingCrop.Phenology.Stage >= 3.0) && (existingCrop.Phenology.Stage < 6.0))\r\n          \r\n            //Is the irrigator available?\r\n            IrrigatorIsAvailable = false;\r\n            DaysSinceIrrigation += 1;\r\n            if (DaysSinceIrrigation >= returndays)\r\n                IrrigatorIsAvailable = true;\r\n          \r\n            //Is the soil dry enough to require irrigation?\r\n            SoilIsDry = false;\r\n            double depthFromSurface = 0.0;\r\n            double fracLayer = 0.0;\r\n            TopSWC = 0.0;\r\n            for (int layer = 0; layer < nLayers; layer++)\r\n            //for (int layer = 0; depthFromSurface < depthPAWC + soilPhysical.Thickness[layer]; layer++)\r\n            {\r\n                fracLayer = Math.Min(1.0, (depthPAWC - depthFromSurface) / soilPhysical.Thickness[layer]);\r\n                TopSWC += waterBalance.SWmm[layer] * fracLayer;\r\n                depthFromSurface += soilPhysical.Thickness[layer];\r\n                if (depthFromSurface >= depthPAWC)\r\n                    layer = nLayers;\r\n            }\r\n            \r\n            TopSWdeficit = TopSWC - TopDUL;\r\n            if (Math.Max(0.0, -TopSWdeficit) >= (TopDUL - TopLL) * (100 - triggerDeficit) / 100)\r\n                SoilIsDry = true;\r\n                \r\n            //Are all the conditions ratifying irrigation\r\n            if (IrrigationIsAllowed && SeasonIsOpen && CropIsActive && IrrigatorIsAvailable && SoilIsDry)\r\n            {\r\n                //Lets bloody well irrigate then!!!!\r\n                AmountToApply = TopDUL * targetDeficit / 100 - TopSWC;\r\n                AmountToApply = Math.Max(0.0, Math.Min(AmountToApply, seasonsAllocation - SeasonAppliedAmount));\r\n                AmountToApply = Math.Min(AmountToApply,maximumAmount);\r\n                Irrigation.Apply(AmountToApply);\r\n                DaysSinceIrrigation = 0;\r\n                SeasonAppliedAmount += AmountToApply;\r\n            }\r\n        }\r\n        \r\n        ///Checks whether theDate is between iniDate and endDate (non-year specific)\r\n        private bool isBetween(DateTime theDay, DateTime iniDate, DateTime endDate)\r\n        {\r\n            bool result = false;\r\n            if (iniDate.DayOfYear < endDate.DayOfYear)\r\n            {\r\n                // period is within one year, ex: summer in the northern hemisphere\r\n                if ((theDay.DayOfYear >= iniDate.DayOfYear) && (theDay.DayOfYear <= endDate.DayOfYear))\r\n                    result = true;\r\n            }\r\n            else\r\n            {\r\n                // period goes over the end of the year, ex: summer in the southern hemisphere\r\n                if ((theDay.DayOfYear >= iniDate.DayOfYear) || (theDay.DayOfYear <= endDate.DayOfYear))\r\n                    result = true;\r\n            }\r\n            \r\n            return result;\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "allowIrrigation",
              "Value": "True"
            },
            {
              "Key": "seasonStart",
              "Value": "1-sep"
            },
            {
              "Key": "seasonEnd",
              "Value": "30-mar"
            },
            {
              "Key": "seasonsAllocation",
              "Value": "10000"
            },
            {
              "Key": "triggerDeficit",
              "Value": "50"
            },
            {
              "Key": "targetDeficit",
              "Value": "95"
            },
            {
              "Key": "returndays",
              "Value": "3"
            },
            {
              "Key": "maximumAmount",
              "Value": "30"
            },
            {
              "Key": "depthPAWC",
              "Value": "650"
            }
          ],
          "Name": "AutomaticIrrigation",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Interfaces;\nusing System;\r\nusing System.Linq;\nusing Models.Core;\nusing System.Collections.Generic;\nusing System.Text;\nusing Models.Soils;\nusing Models.PMF;\nusing Models;\nusing System.Xml.Serialization;\nusing APSIM.Shared.Utilities;\nusing Models.Interfaces;\nnamespace Models\n{\n    [Serializable] \n    public class Script : Model\n    {\n        [Link] private Zone zone;\n        [Link] private Irrigation irrigation;\n        [Link] private ISoilWater waterBalance;\n        [Link] private IPhysical soilPhysical;\n        public double FASW { get; set; }\n        public double WaterDeficit  { get; set; }\n    \n\n\n        [Description(\"Crop to irrigate\")]\n        public IPlant Crop { get; set; }\n        \n        [Description(\"Auto irrigation on?\")]\n        public bool AutoIrrigationOn { get; set; }\n\n        [Description(\"Threshold fraction available water (0-1)\")]\n        public double FASWThreshold { get; set; }\n\n        [Description(\"Soil depth (mm) to which fraction available water is calculated\")]\n        public double FASWDepth { get; set; }\n\n        [Description(\"Minimum weeks between irrigations\")]\n        public double weeks { get; set; }\n\n        [Description(\"Minimum days after sowing for first irrigation\")]\n        public int afterSowing { get; set; }\n\n        private double irrigationGap = 0;    // gap between irrigations\n\n        /// <summary>Called at start of simulation. Performs some basic error checking. </summary>\n        [EventSubscribe(\"StartOfSimulation\")]\n        private void ErrorChecking(object sender, EventArgs args)\n        {\n            if (Crop == null)\n                throw new Exception(\"No crop was specified in script \" + Parent.Name);\n        }\n\n        [EventSubscribe(\"DoManagement\")]\n        private void OnDoManagement(object sender, EventArgs e)\n        {\n            if (AutoIrrigationOn && Crop.IsAlive)\n            {\n                   irrigationGap += 1;                // increment gap between irrigations\n                CalculateFASW();                // calc FASW and WaterDeficit\n                if ((FASW < FASWThreshold) && (irrigationGap >= weeks * 7))\n                {\n                    irrigation.Apply(WaterDeficit, depth: 0);\n                    irrigationGap = 0;            // reset\n                }\n            }\n            else\n            {\n                irrigationGap = weeks * 7 - afterSowing - 1;    // allow irrigation a number of days after it becomes alive/sown\n            }\n        }\n\n        // Calculate the fraction of the potential available sw\n        // Calculate the deficit amount from DUL\n        private void CalculateFASW()\n        {\n            double[] LL15 = MathUtilities.Multiply(soilPhysical.LL15, soilPhysical.Thickness);\n            double[] DUL = MathUtilities.Multiply(soilPhysical.DUL, soilPhysical.Thickness);\n        \n            int nlayr = GetLayerIndex(FASWDepth);\n            double cumdep = MathUtilities.Sum(soilPhysical.Thickness, 0, nlayr, 0.0);    // tricky function that sums up to before nlayr\n\n            double part_layer = MathUtilities.Divide((FASWDepth - cumdep), soilPhysical.Thickness[nlayr], 0.0);\n\n            // note that results may be strange if swdep < ll15\n            double avail_sw = (MathUtilities.Sum(waterBalance.SWmm, 0, nlayr, 0.0) + part_layer * waterBalance.SWmm[nlayr])\n                            - (MathUtilities.Sum(LL15, 0, nlayr, 0.0) + part_layer * LL15[nlayr]);\n\n            double pot_avail_sw = (MathUtilities.Sum(DUL, 0, nlayr, 0.0) + part_layer * DUL[nlayr])\n                                - (MathUtilities.Sum(LL15, 0, nlayr, 0.0) + part_layer * LL15[nlayr]);\n            \n            FASW = MathUtilities.Divide(avail_sw, pot_avail_sw, 0.0);\n            WaterDeficit = MathUtilities.Constrain(pot_avail_sw - avail_sw, 0.0, 100000);\n        }\n\n        // Get index of the layer that has this depth in it \n        private int GetLayerIndex(double pointDepth)\n        {\n            double[] cumThickness = soilPhysical.ThicknessCumulative;\n            int layerIdx = 0;\n            while ((layerIdx < cumThickness.Length) && (pointDepth > cumThickness[layerIdx]))\n            {\n                layerIdx += 1;\n            }\n\n            return layerIdx;\n        }\n    }\n}\n",
          "Parameters": [
            {
              "Key": "Crop",
              "Value": ""
            },
            {
              "Key": "AutoIrrigationOn",
              "Value": "True"
            },
            {
              "Key": "FASWThreshold",
              "Value": "0.9"
            },
            {
              "Key": "FASWDepth",
              "Value": "600"
            },
            {
              "Key": "weeks",
              "Value": "3"
            },
            {
              "Key": "afterSowing",
              "Value": "2"
            }
          ],
          "Name": "Automatic irrigation based on water deficit",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\nusing System;\nusing System.Linq;\nusing Models.Core;\nusing Models.PMF;\nusing APSIM.Shared.Utilities;\nnamespace Models\n{\n\t[Serializable]\n\tpublic class Script : Model\n\t{\n\t\t[Link] Clock Clock;\n\t\t[Link] Irrigation Irrigation;\n\t\t[Link] Water Water;\n\n\t\t[Description(\"SoilCrop module\")] \n    \tpublic SoilCrop CropSoil { get; set;}\n\n  \t\t[Description(\"Plant available water to reset at sowing (mm)\")] \n    \tpublic double SowPAW { get; set; }\n    \t\n\t\t///<summary>The deficit (amount of water applied) at sowing.</summary>\n\t\t[Units(\"mm\")]\n    \tpublic double WaterDeficit{ get; set; }\n   \n    \t[EventSubscribe(\"Sowing\")]\n    \tprivate void OnSowing(object sender, EventArgs e)\n    \t{\n    \t\tif (CropSoil == null)\n    \t\t\tthrow new Exception(\"No CropSoil was specified in \" + Name);\n\t    \tWaterDeficit = SowPAW - CropSoil.PAWmm.Sum();\n\t    \tif (WaterDeficit > 0)\n            \tIrrigation.Apply(amount: WaterDeficit, depth: 0, efficiency: 1);\n        }\n    }\n}\n",
          "Parameters": [
            {
              "Key": "CropSoil",
              "Value": ""
            },
            {
              "Key": "SowPAW",
              "Value": "180"
            }
          ],
          "Name": "Irrigate to crop PAW at sowing",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\r\nusing System;\r\nusing System.Linq;\nusing System.Diagnostics;\r\nusing Models.Core;\r\nusing Models.Interfaces;\r\nusing APSIM.Shared.Utilities;\n\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock clock;\n        [Link] IWeather weather;\r\n        [Link] Irrigation irrigation;\r\n        [Link] ISummary summary;\n        [Link] Physical physical;\n        [Link] Water water;\n    \r\n        [Separator(\"All soils\")]\n\r\n        [Description(\"Start of irrigation season (dd-mmm)\")] \r\n        public string IrrigStart { get; set; }\r\n\n        [Description(\"End of irrigation season (dd-mmm)\")] \r\n        public string IrrigEnd { get; set; }\r\n\r\n        [Description(\"Enter the depth to which water deficit is computed (mm)\")] \r\n        public double SoilDepth { get; set; }\r\n        \r\n        [Description(\"PAW below which soil is considered 'shallow' (mm)\")] \r\n        public double CritPAWForShallow { get; set; }\r\n\n        [Description(\"Amount of rainfall over the last 3 days to cause pause to irrigator (mm)\")] \r\n        public double CritRainToPause { get; set; }\r\n\r\n        [Description(\"Number of days to pause irrigator after critical delay (days)\")] \r\n        public double DaysToPauseOnCritRain { get; set; }\n        \n        [Separator(\"Shallow soils\")]\n        \n        [Description(\"Irrigation return period for shallow soils (days)\")] \r\n        public double IrrigReturnShallow { get; set; }\n\n        [Description(\"Effective irrigation amount for shallow soils (mm)\")] \r\n        public double IrrigAmtShallow { get; set; }\n\n        [Description(\"Percentage of PAW at which to irrigate shallow soils (%)\")] \r\n        public double PercPAWIrrigDeficitShallow { get; set; }\n\n        [Description(\"Irrigation efficiency for shallow soils (%)\")] \r\n        public double IrrigEffShallow { get; set; }\n\n        [Separator(\"Deep soils\")]\n        \n        [Description(\"Irrigation return period for deep soils (days)\")] \r\n        public double IrrigReturnDeep { get; set; }\n\n        [Description(\"Effective irrigation amount for deep soils (mm)\")] \r\n        public double IrrigAmtDeep { get; set; }\n\n        [Description(\"Percentage of PAW at which to irrigate deep soils (%)\")] \r\n        public double IrrigDeficitDeep { get; set; }\n\n        [Description(\"Irrigation efficiency for deep soils (%)\")] \r\n        public double IrrigEffDeep { get; set; }\n\n\n\t    // Output variables\n\t\t[Units(\"mm\")]\n\t\tpublic double TodayDeficit {get; set; }\n\t\t \n\t\t[Units(\"mm\")]\n\t\tpublic double TodayDeficit_nve {get; set; }\n\t\t \n\t\t[Units(\"\")]\n\t\tpublic double IrrigDay {get; set; }\n\t\t \n\t\t[Units(\"\")]\n\t\tpublic double SoilPAW {get; set; }\n\t\t \n\t\t[Units(\"\")]\n\t\tpublic double IrrigDeficit {get; set; }\n\t\t\n\t\t[Units(\"\")]\n\t\tpublic double IrrigReturn {get; set; }\n\t\t\n\t\t[Units(\"\")]\n\t\tpublic double IrrigAmt {get; set; }\n\t\t\n\t\t[Units(\"\")]\n\t\tpublic double IrrigEff {get; set; }\n\t\t\n\t\t[Units(\"mm\")]\n\t\tpublic double Rain3 {get; set; }\n\t\t\n\t\t[Units(\"mm\")]\n\t\tpublic double[] Rain_3 {get; set; } = new double[3];\n\t\t\n\t\t[Units(\"\")]\n\t\tpublic double Days2Pause {get; set; }\n\n \t\t// private variables\n\t\tprivate double irrigDeficitShallow {get; set; }\n\n        \n        [EventSubscribe(\"StartOfSimulation\")]\r\n        private void OnStartOfSimulation(object sender, EventArgs e)\n        {\n\t\t    IrrigDay = 5000;  // so will reset to 1 on first day\n\n\t\t    Rain3 = 0.0;\n\t\t    Rain_3[0] = 0.0; Rain_3[1] = 0.0; Rain_3[2] = 0.0;\n\n\t\t    SoilPAW = 0.0;\n\t\t    double mySoilDepth = 0;\n\t\t    for (int z = 0; z <= physical.Thickness.Length - 1; z++)\n\t\t    {\n\t\t        mySoilDepth = mySoilDepth + physical.Thickness[z];\n\t\t        if (mySoilDepth <= SoilDepth)\n\t\t            SoilPAW = SoilPAW + physical.DULmm[z] - physical.LL15mm[z];\n\t\t    }\n\t\t    if (SoilPAW <= CritPAWForShallow)\n\t\t    {\n\t\t        IrrigDeficit = PercPAWIrrigDeficitShallow / (double)100 * SoilPAW;\n\t\t        IrrigReturn = IrrigReturnShallow;\n\t\t        IrrigAmt = IrrigAmtShallow;\n\t\t        IrrigEff = IrrigEffShallow;\n\t\t        summary.WriteMessage(this, \"Soil is considered to be shallow \" + CritPAWForShallow + \" \" + SoilPAW, MessageType.Information);\n\t\t    }\n\t\t    else\n\t\t    {\n\t\t        IrrigDeficit = IrrigDeficitDeep;\n\t\t        IrrigReturn = IrrigReturnDeep;\n\t\t        IrrigAmt = IrrigAmtDeep;\n\t\t        IrrigEff = IrrigEffDeep;\n\t\t        summary.WriteMessage(this, \"Soil is considered to be deep\", MessageType.Information);\n\t\t    }\n\n\t\t    summary.WriteMessage(this, $\"Irrigation critical deficit (mm): {IrrigDeficit}\", MessageType.Information);\n\t\t    summary.WriteMessage(this, $\"        Irrigation return (days): {IrrigReturn}\", MessageType.Information);\n\t\t    summary.WriteMessage(this, $\"   Irrigation pumped amount (mm): {IrrigAmt}\", MessageType.Information);\n\t\t    summary.WriteMessage(this, $\"       Irrigation efficiency (%): {IrrigEff}\", MessageType.Information);\n        }\n        \n        \r\n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n\t\t    Rain_3[2] = Rain_3[1];\n\t\t    Rain_3[1] = Rain_3[0];\n\t\t    Rain_3[0] = weather.Rain;\n\t\t    Rain3 = Rain_3[0] + Rain_3[1] + Rain_3[2];\n\t\t    if (Rain3 >= CritRainToPause)\n\t\t        Days2Pause = DaysToPauseOnCritRain;\n\t\t    else\n\t\t        Days2Pause = Days2Pause - 1;\n\n\t\t    TodayDeficit = 0.0;\n\t\t    SoilPAW = 0.0;\n\t\t    double mySoilDepth = 0;\n\n\t\t    for (int z = 0; z <= physical.Thickness.Length - 1; z++)\n\t\t    {\n\t\t        mySoilDepth = mySoilDepth + physical.Thickness[z];\n\t\t        if (mySoilDepth <= SoilDepth)\n\t\t        {\n\t\t            SoilPAW = SoilPAW + physical.DULmm[z] - physical.LL15mm[z];\n\t\t            TodayDeficit = TodayDeficit + physical.DULmm[z] - Math.Min(physical.DULmm[z], water.MM[z]);\n\t\t        }\n\t\t    }\n\t\t    TodayDeficit_nve = -1 * TodayDeficit;\n\n\t\t    if (DateUtilities.WithinDates(IrrigStart, clock.Today, IrrigEnd))\n\t\t    {\n\t\t        if (SoilPAW <= CritPAWForShallow)\n\t\t        {\n\t\t            IrrigDeficit = PercPAWIrrigDeficitShallow / 100 * SoilPAW;\n\t\t            IrrigReturn = IrrigReturnShallow;\n\t\t            IrrigAmt = IrrigAmtShallow;\n\t\t            IrrigEff = IrrigEffShallow;\n\t\t        }\n\t\t        else\n\t\t        {\n\t\t            IrrigDeficit = IrrigDeficitDeep;\n\t\t            IrrigReturn = IrrigReturnDeep;\n\t\t            IrrigAmt = IrrigAmtDeep;\n\t\t            IrrigEff = IrrigEffDeep;\n\t\t        }\n\n\t\t        if (Days2Pause < 0.5)\n\t\t        {\n\t\t            IrrigDay = IrrigDay + 1;\n\t\t            if (IrrigDay > IrrigReturn)\n\t\t                IrrigDay = 1;// and day = 1 is when the irrigation happens\n\n\t\t            if (TodayDeficit >= IrrigDeficit)\n\t\t            {\n\t\t                if (IrrigDay == 1)\n                            irrigation.Apply(amount: IrrigAmt / (IrrigEff / 100.0));\r\n\t\t            }\n\t\t        }\n\t\t    }\n\t    }\t\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "IrrigStart",
              "Value": "1-sep"
            },
            {
              "Key": "IrrigEnd",
              "Value": "30-apr"
            },
            {
              "Key": "SoilDepth",
              "Value": "500"
            },
            {
              "Key": "CritPAWForShallow",
              "Value": "60"
            },
            {
              "Key": "CritRainToPause",
              "Value": "30"
            },
            {
              "Key": "DaysToPauseOnCritRain",
              "Value": "3"
            },
            {
              "Key": "IrrigReturnShallow",
              "Value": "2"
            },
            {
              "Key": "IrrigAmtShallow",
              "Value": "10"
            },
            {
              "Key": "IrrigEffShallow",
              "Value": "100"
            },
            {
              "Key": "IrrigReturnDeep",
              "Value": "4"
            },
            {
              "Key": "IrrigAmtDeep",
              "Value": "20"
            },
            {
              "Key": "IrrigDeficitDeep",
              "Value": "25"
            },
            {
              "Key": "IrrigEffDeep",
              "Value": "100"
            },
            {
              "Key": "PercPAWIrrigDeficitShallow",
              "Value": "0"
            },
            {
              "Key": "allowIrrigation",
              "Value": "True"
            }
          ],
          "Name": "CentrePivot",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        }
      ],
      "Enabled": true,
      "ReadOnly": false
    },
    {
      "$type": "Models.Core.Folder, Models",
      "ShowInDocs": false,
      "GraphsPerPage": 6,
      "Name": "Soil",
      "ResourceName": null,
      "Children": [
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Climate;\nusing APSIM.Shared.Utilities;\nusing Models.Soils.Nutrients;\nusing Models.Soils;\nusing Models.PMF;\nusing Models.Core;\nusing System.Xml.Serialization;\nusing System;\r\nusing System.Linq;\nusing Models.AgPasture;\nusing Models.Interfaces;\n\nnamespace Models\n{\n    [Serializable] \n    [System.Xml.Serialization.XmlInclude(typeof(Model))]\n    public class Script : Model\n    {\n        [Link] Clock clock;\n        [Link] ISummary summary;\n        [Link] private Swim3 swim;\n        //[Link] private PastureSpecies ryegrass;\n        //[Link] private SimpleGrazing grazing;\n        \n        public enum LowerBCTypeOptions {gradient,seepage,potential,watertable};\n\n        [Separator(\"Sets the lower boundary condition type (and value if set to 'potential' for SWIM3. The change is applied at the beginning of the first day of the simulation.\")]\n        \n        [Description(\"What lower boundary condition is wanted?\")] public LowerBCTypeOptions LowerBCType { get; set; }\n\n\n        [Display(VisibleCallback = \"IsBCPotentialOrWater\")]\n        [Description(\"What should the lower BC potential be set to (should be positive for a watertable) (mm)?\")] public double LowerBCValue { get; set; }\n        \n        public bool IsBCPotentialOrWater => LowerBCType == LowerBCTypeOptions.potential || LowerBCType == LowerBCTypeOptions.watertable;\n\n\n\n\n\n        public double SoilWaterStart  { get; set; }\n        public double SoilWaterEnd  { get; set; }\n\n        [EventSubscribe(\"DoDailyInitialisation\")]\n        private void DoDailyInitialisation(object sender, EventArgs e)\n        {\n        }\n\n        [EventSubscribe(\"DoReportCalculations\")]\n        private void DoReportCalculations(object sender, EventArgs e)\n        {\n        }\n\n        [EventSubscribe(\"DoManagement\")]\n        private void DoDailyCalculations(object sender, EventArgs e)\n        {\n            if (clock.Today == clock.StartDate)\n            {\n                summary.WriteMessage(this, \"Script is setting lower boundary condition to \" + LowerBCType, MessageType.Diagnostic);\n                if (LowerBCType == LowerBCTypeOptions.gradient)\n                    swim.SetLowerBCForGradient(bbcGradient: 0.0);   // in cm/cm (ibbc=0) Note that this is the default setting\n                else if (LowerBCType == LowerBCTypeOptions.potential)\n                    swim.SetLowerBCForGivenPotential(bbcPotential: LowerBCValue /10.0 );    //  convert to cm (ibbc=1), DUL is -100 cm so values more positive will often result in inflow to the bottom of the soil profile. Input in mm so divide here.\n                else if (LowerBCType == LowerBCTypeOptions.seepage)\n                    swim.SetLowerBCForSeepage(bbcPotentialSeepage: 0.0);  // in cm (ibbc=3). This is for zero-tension lysimeters\n                else if (LowerBCType == LowerBCTypeOptions.watertable)\n                    swim.SetLowerBCForSeepage(LowerBCValue / 10.0);  // in cm (ibbc=4). This is for water tables\n                else\n                    throw new Exception(\"Wrong lower boundary condition type\");\n            }\n        }\n    }\n}\n",
          "Parameters": [
            {
              "Key": "LowerBCType",
              "Value": "watertable"
            },
            {
              "Key": "LowerBCValue",
              "Value": "500"
            }
          ],
          "Name": "SWIMSetLowerBC",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Climate;\r\nusing APSIM.Shared.Utilities;\r\nusing Models.Soils.Nutrients;\r\nusing Models.Soils;\r\nusing Models.PMF;\r\nusing Models.Core;\r\nusing System.Xml.Serialization;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.AgPasture;\r\nusing Models.Interfaces;\r\n\r\nnamespace Models\r\n{\r\n    [Serializable] \r\n    [System.Xml.Serialization.XmlInclude(typeof(Model))]\r\n    public class Script : Model\r\n    {\r\n        [Link] ISummary summary;\r\n        [Link] private Swim3 swim;\r\n        \n        public enum SurfaceBCOptions { CurveNumber, PowerFunction };\r\n\n\t\t[Separator(\"Sets SWIMs surface boundary condition to either a curve number approach or a power function.\")]\n        \n\r\n        [Description(\"What surface boundary condition?\")] \n        public SurfaceBCOptions SurfaceBCType { get; set; }\r\n\n        [Description(\"Minimum surface storage (mm):\")] \n        [Display(EnabledCallback = \"IsPowerFunction\")] \n        public double MinimumSurfaceStorage { get; set; }\r\n\n        [Description(\"Maximum surface storage (mm):\")] \n        [Display(EnabledCallback = \"IsPowerFunction\")] \n        public double MaximumSurfaceStorage { get; set; }\r\n\n        [Description(\"Initial surface storage (mm):\")] \n        [Display(EnabledCallback = \"IsPowerFunction\")] \n        public double InitialSurfaceStorage { get; set; }\r\n\n        [Description(\"Precipitation constant:\")] \n        [Display(EnabledCallback = \"IsPowerFunction\")] \n        public double PrecipitationConstant { get; set; }\r\n\n        [Description(\"Runoff rate factor:\")] \n        [Display(EnabledCallback = \"IsPowerFunction\")] \n        public double RunoffRateFactor { get; set; }\r\n\n        [Description(\"Runoff rate power:\")] \n        [Display(EnabledCallback = \"IsPowerFunction\")] \n        public double RunoffRatePower { get; set; }\r\n\n        /// <summary></summary>\n        public bool IsPowerFunction => SurfaceBCType == SurfaceBCOptions.PowerFunction;\n\n\r\n        [EventSubscribe(\"StartOfSimulation\")]\r\n        private void DoDailyInitialisation(object sender, EventArgs e)\r\n        {\n            summary.WriteMessage(this, \"Script is setting surface boundary condition to \" + SurfaceBCType, MessageType.Diagnostic);\r\n            if (SurfaceBCType == SurfaceBCOptions.CurveNumber)\n            \tswim.SetSurfaceBCForCurveNumber();\r\n            else if (SurfaceBCType == SurfaceBCOptions.PowerFunction)\n                swim.SetSurfaceBCForPowerFunction(minimumSurfaceStorage: 10, \n                  \t\t\t\t\t\t\t      maximumSurfaceStorage: 20, \n                   \t\t\t\t\t\t\t      initialSurfaceStorage: 15, \n                   \t\t\t\t\t\t\t      precipitationConstant: 50, \n                   \t\t\t\t\t\t\t      runoffRateFactor: 0.2, \n                   \t\t\t\t\t\t\t      runoffRatePower: 2);\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "SurfaceBCType",
              "Value": "CurveNumber"
            },
            {
              "Key": "MinimumSurfaceStorage",
              "Value": "10"
            },
            {
              "Key": "MaximumSurfaceStorage",
              "Value": "20"
            },
            {
              "Key": "InitialSurfaceStorage",
              "Value": "15"
            },
            {
              "Key": "PrecipitationConstant",
              "Value": "50"
            },
            {
              "Key": "RunoffRateFactor",
              "Value": "0.2"
            },
            {
              "Key": "RunoffRatePower",
              "Value": "2"
            }
          ],
          "Name": "SWIMSetSurfaceBC",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Climate;\nusing APSIM.Shared.Utilities;\nusing Models.Soils.Nutrients;\nusing Models.Soils;\nusing Models.Soils.SoilTemp;\nusing Models.PMF;\nusing Models.Core;\nusing System.Xml.Serialization;\nusing System;\nusing Models.AgPasture;\nusing Models.Interfaces;\nusing System.Diagnostics;\n\n// This module estimate the amount of NH3 in the soil and its volatilisation\n\nnamespace Models\n{\n    [Serializable] \n    [System.Xml.Serialization.XmlInclude(typeof(Model))]\n    public class Script : Model\n    {\n\t\t[Link]\n\t\tprivate IWeather weather;\n\t\t\n\t\t[Link]\n\t\tprivate ISoilWater waterBalance;\n\t\t \n\t\t[Link]\n\t\tprivate Irrigation irrigation;\n\n\t\t[Link]\n\t\tprivate Nutrient nutrient;\n\n\t\t[Link]\n\t\tprivate Swim3 swim;\n\n\t\t[Link]\n\t\tprivate NFlow hydrolysis;\n\n\t\t[Link]\n\t\tprivate NFlow nitrification;\t\t\n\n\t\t[Link]\n\t\tprivate ISolute nh4;\n\t\t\t\t\n\t\t[Link]\n\t\tprivate Physical physical;\n\n\t\t[Link]\n\t\tprivate Chemical chemical;\n\n\t\t[Link(IsOptional=true)]\n\t\tprivate SoilTemperature soilTemperature;\n\t\t\n\t\t[Link(IsOptional=true)]\n\t\tprivate CERESSoilTemperature ceresSoilTemperature;\n\t\t\n\t    // Parameter variables:\n\t    [Separator(\"NH3 volatilisation parameters\")]\n    \t[Description(\"Depth to which NH3 volatilisation is considered (mm):\")]\n    \tpublic double Depth_for_NH3 { get; set; }\n    \n    \t[Separator(\"Base soil and pH change parameters\")]            \n    \t[Description(\"The base soil pH for each soil layer:\")]\n    \tpublic string Soil_pH_base { get; set; }             // The base soil pH, apsim will try to keep to this value, same for all layers\n    \t[Description(\"The CEC for each layer (meq/100g)\")] \n    \tpublic string CEC_strng { get; set; }           // The CEC for each layer (meq/100g)\n    \t[Description(\"Soil buffer capacity factor\")] \n    \tpublic double k_BC { get; set; }                    // Soil buffer capacity factor ()\n    \t[Description(\"Factor to convert urea hydrolysed into H+ changes\")] \n    \tpublic double k_pH_hyd { get; set; }                 // Factor to convert urea hydrolysed into H+ changes ()\n    \t[Description(\"Factor to convert NH4 nitrified into H+ changes\")] \n    \tpublic double k_pH_nit { get; set; }                 // Factor to convert NH4 nitrified into H+ changes ()\n    \t[Description(\"Minimum decrease for pH (fraction/day)\")] \n    \tpublic double k_pH_x { get; set; }                   // Minimum decrease for pH (fraction/day)\n    \t\n    \t[Separator(\"Gas exchange parameters\")]\n    \t[Description(\"Factor for soil/atmosphere gas exchange (AFPV/mm):\")] \n    \tpublic double k_AFPV { get; set; }                   // Factor to transform potential evaporation in air filled pore volumes that are potential exchanged with to atmosphere\n    \t[Description(\"Fractor for volatilisable NH3, per soil layer (0-1):\")] \n    \tpublic string f_NV_strng { get; set; }               // The fraction of potential NH3 volatilisation for each layer that is transpoted to the soil surface ()\n\n\t\t[Separator(\"Additional limits for volatilisation\")]\n    \t[Description(\"Fraction of total soil NH4 that can be volatilised per day:\")] \n    \tpublic double f_AV { get; set; }                     // Fraction of total soil NH4 that can be volatilised per day, limits volatilisation and ensure mass balance ()\n    \t[Description(\"Rain+irrigation below which volatilisation is not limited (mm):\")] \n    \tpublic double CritRain1 { get; set; }                // Critial rainfall. Below this volatilisation is not limited by rainfall or irrigation\n    \t[Description(\"Rain+irrigation above which no volatilisation occur (mm):\")] \n    \tprivate double CritRain2 { get; set; }                // Critial rainfall. Above this no volatilisation occurs\n\t\t\n    \t// Output variables\n\t    [Units(\"ppm\")]\n\t    public double[] NH3ppm { get; set; }  // The estimated amount of NH3 in the soil (ppm)\n\n\t    [Units(\"kgN/ha\")]\n\t    public double[] NH3 { get; set; }               // The estimated amount of NH3 in the soil (kg/ha)\n\t    \n\t    [Units(\"g/ha\")]\n\t    public double[] NH3Gas { get; set; }             // The estimated amount of NH3 in the soil in gaseous form (g/ha)\n    \n    \t[Units(\"kgN/ha\")]\n\t    public double[] EmissionNH3 { get; set; }      // The estimated amount of NH3 volatilised (kg/ha/day)\n    \n    \t[Units(\"\")]\n\t    public double[] SoilpH { get; set; }                 // dummy soil pH\n    \n    \t[Units(\"kgN/ha\")]\n\t    public double[] NH4Sol { get; set; }           // The amount of NH4 in the soil solution (kg/ha)   \n    \n    \t[Units(\"oC\")]\n\t    public double[] SoilTemp { get; set; }              // The soil temperature (oC)\n\n    \t[Units(\"AFPV/day\")]\n\t    public double PotGasExchangeNH { get; set; }  // The potential soil-atmosphere gas exchange (Air-filled-pore-spaces/day)\n    \n        [Units(\"L/m2/day\")]\n    \tpublic double[] GasExchangeNH { get; set; }   // The volume of gas exchanged (L/m2/day)\n    \t\n    \t[Units(\"L/m2\")]\n\t    public double[] AirFilledPoreVolume { get; set; } // The volume of air filled pore space in each soil layer (L_air/m2)\n    \n    \t[Units(\"\")]\n\t    public double[] NH3toNHxRatio { get; set; }          // The ratio between NH3 and NHx in the soil solution\n    \n    \t[Units(\"x1000\")]\n\t    public double[] NH3GtoNH3ARatio { get; set; }   // The ratio between NH3 liquide and gas in the soil, times 1000\n    \n\t    [Units(\"\")]\n\t    public double[] pK_NHx { get; set; }                  // The equilibrium constant for NH4-NH3\n    \t\n    \t[Units(\"\")]\n    \tpublic double[] pG_NH3 { get; set; }                  // The equilibrium constant for NH3A-NH3G\n\n    \t// Internal variables\n    \tprivate int NH3_z;                           // The layer to consider NH3 volatilization\n    \tprivate double[] f_NV;                           // The fraction of NH3 transport from each layer\n    \tprivate double[] Ini_SoilpH;                     // The initial, or base, soil pH\n    \tprivate double[] SoilCEC;                        // The CEC (mol/kg)\n\n    \t[EventSubscribe(\"StartOfSimulation\")]\n        private void OnStartOfSimulation(object sender, EventArgs e)\n    \t{\n    \t//Debugger.Break();\n        \tSoilpH = new double[waterBalance.Thickness.Length];\n        \tIni_SoilpH = new double[waterBalance.Thickness.Length];\n\n        \t// Split the read values of f_NV into an array\n        \tf_NV = makeArray(f_NV_strng);\n        \t// Split the read values of pH into an array\n        \tIni_SoilpH = makeArray(Soil_pH_base);\n        \t// Split the read values of CEC into an array\n        \tSoilCEC = makeArray(CEC_strng);\n        \tvar oldIni_SoilpH = Ini_SoilpH;\n        \tIni_SoilpH = new double[waterBalance.Thickness.Length];\n        \tif (oldIni_SoilpH != null)\n\t            Array.Copy(oldIni_SoilpH, Ini_SoilpH, Math.Min(waterBalance.Thickness.Length, oldIni_SoilpH.Length));\n        \tvar oldSoilCEC = SoilCEC;\n        \tSoilCEC = new double[waterBalance.Thickness.Length];\n        \tif (oldSoilCEC != null)\n\t            Array.Copy(oldSoilCEC, SoilCEC, Math.Min(waterBalance.Thickness.Length, oldSoilCEC.Length));\n        \t// Assign initial pH values and convert CEC from meq to mol\n        \tfor (int z = 0; z < waterBalance.Thickness.Length; z++)\n        \t{\n\t            Ini_SoilpH[z] = Math.Max(0, Ini_SoilpH[z]);\n            \tSoilpH[z] = Ini_SoilpH[z];\n            \tSoilCEC[z] = 0.01 * Math.Max(0.1, SoilCEC[z]);     // mol/kg\n        \t}\n\t\n        \t// Identify the layer down to which volatilization is considered\n        \tdouble Depth_from_surface = 0;\n        \tfor (int z = 0; z < waterBalance.Thickness.Length; z++)\n        \t{\n\t            Depth_from_surface = Depth_from_surface + waterBalance.Thickness[z];\n            \tif (Depth_from_surface <= Depth_for_NH3)\n\t                NH3_z = z;\n            \telse\n\t                z = waterBalance.Thickness.Length;\n        \t}\n\n\t        // verify the bounds of the pH converting factor\n        \tk_pH_hyd = Math.Min(1, Math.Max(0, k_pH_hyd));\n        \tk_pH_nit = Math.Min(1, Math.Max(0, k_pH_nit));\n        \tk_pH_x = Math.Min(1, Math.Max(0, k_pH_x));\n        \tk_BC = Math.Max(0, k_BC);\n        \tvar oldF_NV = f_NV;\n        \tf_NV = new double[waterBalance.Thickness.Length];\n        \tif (oldF_NV != null)\n\t            Array.Copy(oldF_NV, f_NV, Math.Min(waterBalance.Thickness.Length, oldF_NV.Length));\n        \tfor (int z = 0; z < waterBalance.Thickness.Length; z++)\n\t            f_NV[z] = Math.Min(1, Math.Max(0, f_NV[z]));\n\t\n        \t// ----------- NH3 volatilization ---------------------------------------------------\n        \tConsole.WriteLine(\"\");\n        \tConsole.WriteLine(\"Volatilization will be calculated by manager\");\n        \tConsole.WriteLine(\"   Top \" + Depth_for_NH3.ToString() + \"mm are considered,\");\n        \tConsole.WriteLine(\"   pH variation is mimicked by dlt_urea_hydrol + dlt_nh4_nitrif\");\n        \tConsole.WriteLine(\"\");\n    \t}\n\n        [EventSubscribe(\"DoManagementCalculations\")]\n        private void DoManagementCalculations(object sender, EventArgs e)\n        {\n            double urea_hydrol;                    // The amount of urea hydrolised (mol/L)\n            double nh4_nitrif;                     // The amount of NH4 nitrified (mol/L)\n            double dlt_H;                          // Estimated variation of H+ in the soil (mol/L)\n            double delta_pH_Hyd = 0;               // Variation in soil pH due to urea hydrolysis\n            double delta_pH_Nit = 0;               // Variation in soil pH due to NH4 nitrification\n            double delta_pH_x = 0;                 // Minimum decrease in soil pH, to ensure pH returns to base after urea deposition\n            double delta_pH_vol = 0;               // Variatin in pH due to volatilisation\n            double Beta = 1;                       // The soil buffer capacity ()\n            double[] delta_nh4 = new double[waterBalance.Thickness.Length];   // The variation in NH4 content due to volatilisation (kg/ha)\n            double RainFactor = 1.0;               // The rain factor\n    \n            if (ceresSoilTemperature == null)  // to get the soil temperature from SoilTemp, otherwise use SoilN's:\n                SoilTemp = soilTemperature.AverageSoilTemp;\n            else\n                SoilTemp = ceresSoilTemperature.Value;\n    \n            NH3ppm = new double[waterBalance.Thickness.Length];\n            NH4Sol = new double[waterBalance.Thickness.Length];\n            NH3 = new double[waterBalance.Thickness.Length];\n            NH3Gas = new double[waterBalance.Thickness.Length];\n            EmissionNH3 = new double[waterBalance.Thickness.Length];\n            GasExchangeNH = new double[waterBalance.Thickness.Length];\n            AirFilledPoreVolume = new double[waterBalance.Thickness.Length];\n            NH3toNHxRatio = new double[waterBalance.Thickness.Length];\n            NH3GtoNH3ARatio = new double[waterBalance.Thickness.Length];\n            pK_NHx = new double[waterBalance.Thickness.Length];\n            pG_NH3 = new double[waterBalance.Thickness.Length];\n    \n            // Calc the irrigation factor\n            if (weather.Rain + irrigation.IrrigationApplied < CritRain1)\n                RainFactor = 1.0;\n            else if (weather.Rain + irrigation.IrrigationApplied > CritRain2)\n                RainFactor = 0.0;\n            else\n                RainFactor = (weather.Rain + irrigation.IrrigationApplied - CritRain1) / (double)(CritRain2 - CritRain1);\n    \n            // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n            // NOTES:\n            // The RainFactor accounts for the downwards transport of NH3 gas when water from rain or irrigation is being drained throught the soil.\n            // Below RainCrit1, precipitation has no effect, above RainCrit2 volatilisation is zero.  A linear relationship is used between\n            // these two limits:\n            // \n            // |\n            // F   1+                /-----------\n            // R a    |               /:\n            // a c    |              / :\n            // i t    |             /  :\n            // n o    |            /   :\n            // r    |           /    :\n            // |          /     :\n            // |         /      :\n            // 0+========+-------+--------------> Rain + Irrigation\n            // |      Rain    Rain\n            // Crit1   Crit2\n            // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n    \n    \t\tdouble[] dlt_urea_hydrol = hydrolysis.Value;\n    \t\tdouble[] dlt_rntrf = nitrification.Value;\n    \t\tdouble[] conc_water_nh4 = swim.ConcWaterNH4;\n            for (int z = 0; z < waterBalance.Thickness.Length; z++)\n            {\n    \n                // 0-Compute the value of Beta\n                Beta = k_BC * physical.BD[z] * SoilCEC[z] / (double)waterBalance.SW[z];\n    \n                // 1-Compute the consumption of H+ by urea hydrolysis\n                urea_hydrol = dlt_urea_hydrol[z] / (double)(waterBalance.Thickness[z] * 10000);   // kg_urea_N/L_soil\n                urea_hydrol = urea_hydrol * 1000 / (double)waterBalance.SW[z];                 // g_urea_N/L_water\n                urea_hydrol = urea_hydrol / 14.00674;                     // mol_urea_N/L_water  - All N pools as expresseed in kg_N, so molecular mass is 14\n                dlt_H = -2 * urea_hydrol * k_pH_hyd;                      // mol/L\n    \n                // 2-Compute changes in soil pH due to urea hydrolysis\n                if (dlt_H < 0)\n                    delta_pH_Hyd = (14 / (1 + ((14 - SoilpH[z]) / (double)SoilpH[z]) * Math.Pow(10, (dlt_H / (double)Beta)))) - SoilpH[z];\n                else\n                    delta_pH_Hyd = 0;\n                SoilpH[z] = SoilpH[z] + delta_pH_Hyd;\n    \n                // 3-Compute the production of H+ by nitrification and its effect on soil pH\n                nh4_nitrif = dlt_rntrf[z] / (double)(waterBalance.Thickness[z] * 10000);          // kg_nh4_N/L_soil\n                nh4_nitrif = nh4_nitrif * 1000 / (double)waterBalance.SW[z];                   // g_nh4_N/L_water\n                nh4_nitrif = nh4_nitrif / 14.0067;                        // mol_nh4_N/L_water  - All N pools as expresseed in kg_N, so molecular mass is 14\n                dlt_H = 2 * nh4_nitrif * k_pH_nit;                        // mol/L\n                if (dlt_H > 0)\n                    delta_pH_Nit = (14 / (1 + ((14 - SoilpH[z]) / (double)SoilpH[z]) * Math.Pow(10, (dlt_H / (double)Beta)))) - SoilpH[z];\n                else\n                    delta_pH_Nit = 0;\n    \n                // 4-Compute soil forced pH change - this is to ensure pH will decline to its base value\n                if (SoilpH[z] > Ini_SoilpH[z])\n                    delta_pH_x = -(SoilpH[z] - Ini_SoilpH[z]) * k_pH_x;\n                else\n                    delta_pH_x = 0;\n                SoilpH[z] = SoilpH[z] + Math.Min(delta_pH_Nit, delta_pH_x);\n    \n                // 5-bound pH between base and 14\n                SoilpH[z] = Math.Min(14, Math.Max(Ini_SoilpH[z], SoilpH[z]));\n    \n    \n                // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n                // NOTES:\n                // The changes in pH are due to the consumption of H+ as urea is hydrolysed or the production of H+ by nitrification,\n                // in theory for each mol of N hydrolised two mols of H+ are consumed, while two mols are produced by nitrification;\n                // The k_pH_nit ad k_pH_hyd factors allow to control the extent that H+ is affected by hydrolysis and nitrification,\n                // when set to zero there's no effect, while setting it to one causes full theoretical effect\n                // The parameter Beta describes the soil buffer capacity, which is a function of CEC, k_BC is used for adjusting the relationship.\n                // k_pH_x stablish a minimum rate for pH decay, it mimicks soil buffering and other reactions that bring pH down\n                // after urea/urine deposition. Used when nitrification is not enough to bring the pH down.\n                // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n    \n    \n                // 6-compute the NH3 equilibrium factors\n                pK_NHx[z] = pK(\"aq\", SoilTemp[z] + 273.15);      // Aqueous equilibrium [NH4 <--> NH3]\n                pG_NH3[z] = pK(\"gs\", SoilTemp[z] + 273.15);      // Gaseous equilibrium [NH3_liquid <--> NH3Gas]\n    \n                // 7-Calc the proportion of total NHx that is in the form of NH3\n                double NH3toNHx = 1 / (1 + Math.Pow(10, (pK_NHx[z] - SoilpH[z])));\n                NH3toNHxRatio[z] = NH3toNHx;\n    \n                // 8-Calc the amount of NH3 in aqueous solution (original equation uses mol/L, thus the ratio of molecular mass is needed)\n                NH3ppm[z] = conc_water_nh4[z] * NH3toNHx * (17.03 / 18.04);      // ppm (ug/cm3_water)\n    \n                // 9-Calc the proportion of total NH3 that is in the gaseous form\n                double NH3GtoNH3A = 1 / (1 + Math.Pow(10, (pG_NH3[z])));\n                NH3GtoNH3ARatio[z] = NH3GtoNH3A * 1000;\n    \n                // 10-Calc the amount of NH3 in gaseous form\n                NH3Gas[z] = NH3ppm[z] * NH3GtoNH3A;                   // ppm (ug/cm3_air in soil = mg/L)\n    \n                // 11-Calc the amount of NH3 in gaseous form and the amount effectivelly lost by volatilization\n                PotGasExchangeNH = waterBalance.Eo * k_AFPV;   // air filled pore volumes/day\n                AirFilledPoreVolume[z] = (physical.SAT[z] - waterBalance.SW[z]) * waterBalance.Thickness[z];    // L_air/m2\n                if (z <= NH3_z)\n                {\n                    GasExchangeNH[z] = PotGasExchangeNH * AirFilledPoreVolume[z];      // L_air/m2/day\n                    GasExchangeNH[z] = GasExchangeNH[z] * RainFactor;\n                    if (GasExchangeNH[z] > 0)\n                    {\n                        EmissionNH3[z] = NH3Gas[z] * GasExchangeNH[z] * f_NV[z];      // mg/m2\n                        EmissionNH3[z] = EmissionNH3[z] * 10E+4;                      // mg/ha\n                        EmissionNH3[z] = EmissionNH3[z] * 10E-6;                      // kg/ha\n                    }\n                    else\n                        EmissionNH3[z] = 0;\n                    // Limit volatilisation to a fraction of NH4 for each layer\n                    EmissionNH3[z] = Math.Min(EmissionNH3[z], f_AV * nh4.ppm[z]);\n                }\n                else\n                {\n                    GasExchangeNH[z] = 0;\n                    EmissionNH3[z] = 0;\n                }\n    \n    \n                // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n                // NOTES:\n                // To estimate the amount of NH3 volatilised during the day, it is assumed that the amount of NH3 in gaseous form in the\n                // beginning of the day represents well the proportion of NHx 'volatilisable'. It is assumed also that the potential evaporation\n                // is a good estimator for the gas exchange between soil and atmosphere (this makes volatilisation sensible to temperature and\n                // wind).  By scaling the gas exchange to the air filled pore space in the soil, we get volatilisation also sensible to water\n                // content, which mimicks the decrease in gas transport when the soil is wet.  Finally a factor (f_NV) is used to limit the\n                // contribution of each soil layer to the overall volatilisation (deep layers would volatilise less because NH3 needs to move\n                // transport to the surface.\n                // +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n    \n    \n                // 12-Compute soil pH change due to volatilisation\n                double EmissionNH3ised = EmissionNH3[z] / (double)(waterBalance.Thickness[z] * 10000);  // kg_NH3_N/L_soil\n                EmissionNH3ised = EmissionNH3ised * 1000 / (double)waterBalance.SW[z];                      // g_NH3_N/L_water\n                EmissionNH3ised = EmissionNH3ised / 14.0067;                           // mol_NH3_N/L_water  - All N pools as expresseed in kg_N, so molecular mass is 14\n                dlt_H = EmissionNH3ised;                                                // mol/L\n                if (dlt_H > 0)\n                    delta_pH_vol = (14 / (1 + ((14 - SoilpH[z]) / (double)SoilpH[z]) * Math.Pow(10, (dlt_H / (double)Beta)))) - SoilpH[z];\n                else\n                    delta_pH_vol = 0;\n    \n                // 13- Calc new pH and bound it between base and 14\n                SoilpH[z] = SoilpH[z] + delta_pH_vol;\n                SoilpH[z] = Math.Min(14, Math.Max(Ini_SoilpH[z], SoilpH[z]));\n    \n                // 14-Transform variables to publishable units\n                NH3[z] = NH3ppm[z] * waterBalance.SW[z] / (double)1000;                     // mg/cm3_soil = g/L_soil\n                NH3[z] = NH3[z] * waterBalance.Thickness[z] * 10000;                   // g/ha_soil\n                NH3[z] = NH3[z] / (double)1000;                                // kg/ha\n    \n                NH3Gas[z] = NH3Gas[z] * (physical.SAT[z] - waterBalance.SW[z]) / (double)1000;     // mg/cm3_soil = g/L_soil\n                NH3Gas[z] = NH3Gas[z] * waterBalance.Thickness[z] * 10000;           // g/ha_soil\n    \n                NH4Sol[z] = conc_water_nh4[z] * waterBalance.SW[z] / (double)1000;         // mg/cm3_soil = g/L_soil\n                NH4Sol[z] = NH4Sol[z] * waterBalance.Thickness[z] * 10000;           // g/ha_soil\n                NH4Sol[z] = NH4Sol[z] / (double)1000;                        // kg/ha\n    \n                // Compute the delta in nh4 amount\n                delta_nh4[z] = -EmissionNH3[z];\n            }\n            \n            nh4.AddKgHaDelta(SoluteSetterType.Other, delta_nh4);\n   \n        }\n\n\n\n    \tpublic double[] makeArray(string ArrayString)\n    \t{\n\n\t        // Get the string with values from the user interface and put the values in an numeric array\n\n        \tstring[] MyArray_string;\n        \tdouble[] MyArray_single;\n        \tchar[] Separator = \" \".ToCharArray();\n\n        \t// 1-Split string into array\n        \tMyArray_string = ArrayString.Split(Separator, StringSplitOptions.RemoveEmptyEntries);\n\n        \t// 2-convert array into type single\n        \tMyArray_single = new double[MyArray_string.Length - 1 + 1];\n        \tfor (int i = 0; i <= MyArray_single.Length - 1; i++)\n\t            MyArray_single[i] = Convert.ToDouble(MyArray_string[i]);\n        \treturn MyArray_single;\n    \t}\n\n\t    public double pK(string n_species, double Temp)\n    \t{\n\n\t        // Calculates the equilibrium constants, \n        \t// if 'aq' then nh4-NH3 equilibrium in water\n        \t// if 'gs' then gas-liquid equilibrium for NH3\n\n\t        double[] a_pK = new[] { 0.09018, -1.69 };\n        \tdouble[] b_pK = new[] { 2729.92, 1477.7 };\n        \tint sp = 0;\n\n        \tif (n_species == \"aq\")\n\t            sp = 0;\n        \telse if (n_species == \"gs\")\n            \tsp = 1;\n        \treturn a_pK[sp] + b_pK[sp] / Temp;\n    \t}\n    \n\t}\n}\n",
          "Parameters": [
            {
              "Key": "Depth_for_NH3",
              "Value": "50"
            },
            {
              "Key": "Soil_pH_base",
              "Value": "5.7 5.7 5.7 5.3 5.3 5.9 5.9 5.9 6.6 6.6 6.7 6.7 6.7 6.7"
            },
            {
              "Key": "CEC_strng",
              "Value": "28.2 28.2 28.2 21 21 17.3 17.3 17.3 12 12 12.9 12.9 12.9 12.9"
            },
            {
              "Key": "k_BC",
              "Value": "0.03"
            },
            {
              "Key": "k_pH_hyd",
              "Value": "1"
            },
            {
              "Key": "k_pH_nit",
              "Value": "1"
            },
            {
              "Key": "k_pH_x",
              "Value": "0.2"
            },
            {
              "Key": "k_AFPV",
              "Value": "300"
            },
            {
              "Key": "f_NV_strng",
              "Value": "1 1 1 0.3 0"
            },
            {
              "Key": "f_AV",
              "Value": "0.5"
            },
            {
              "Key": "CritRain1",
              "Value": "3"
            }
          ],
          "Name": "SWIMNH3Volatilisation",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Climate;\nusing APSIM.Shared.Utilities;\nusing Models.Soils.Nutrients;\nusing Models.Soils;\nusing Models.Core;\nusing System;\nusing System.Linq;\nusing System.Collections.Generic;\nusing Models.AgPasture;\nusing Models.Interfaces;\n\nnamespace Models\n{\n    [Serializable] \n    [System.Xml.Serialization.XmlInclude(typeof(Model))]\n    public class Script : Model\n    {\n        [Link] Clock clock;\n        [Link] ISummary summary;\n        [Link] private Solute[] solutes;\n\n\t\tprivate Solute solute;\n\t\tprivate List<DateTime> dates = new List<DateTime>();\n\t\tprivate List<double> values = new List<double>();\n\n\t\tpublic enum SetAddType { Set, Add }\n\n\t\t[Separator(\"Set the amount of solute in the simulation on 1 or more dates. The name of the solute can be specified. You can set the amount of solute or add a delta (kg/ha).\")]\n        \n\n\t    [Description(\"Name of solute:\")]\n    \tpublic string SoluteName { get; set; }\n\n\t    [Description(\"Set the value of the solute or add a delta to it?\")]\n    \tpublic SetAddType SetAdd { get; set; }\n\n\t    [Description(\"Dates (csv) for setting (adding to) the solute:\")]\n    \tpublic string DateCsvString { get; set; }\n\n\t    [Description(\"Values (csv) kg/ha:\")]\n    \tpublic string ValueCsvString { get; set; }\n  \n\t\t\n\t\tpublic double SoluteAdded { get; set; }\n\n\t\t[EventSubscribe(\"StartOfSimulation\")]\n        private void OnStartOfSimulation(object sender, EventArgs e)\n\t\t{\n\t\t\tsolute = Array.Find(solutes, s => s.Name.Equals(SoluteName, StringComparison.InvariantCultureIgnoreCase));\n\t\t\tif (solute == null)\n\t\t\t\tthrow new Exception($\"Cannot find solute {SoluteName}\");\n\t\t\n\t\t\tvar dateStrings = DateCsvString.Split(\",\", StringSplitOptions.RemoveEmptyEntries);\n\t\t\tforeach (var d in dateStrings)\n\t\t\t   dates.Add(DateTime.Parse(d));\n\n\t\t\tvar valueStrings = ValueCsvString.Split(\",\", StringSplitOptions.RemoveEmptyEntries);\n\t\t\tforeach (var v in valueStrings)\n\t\t\t   values.Add(Convert.ToDouble(v));\n    \t}\n    \t\n    \t\n        [EventSubscribe(\"DoDailyInitialisation\")] private void DoDailyInitialisation(object sender, EventArgs e)\n        {\n\t       \tSoluteAdded = 0.0;\n        \tforeach (var d in dates)\n        \t{\n        \t\tif (clock.Today == d) \n\t        \t{\n\t        \t\tif (SetAdd == SetAddType.Add)\n\t\t        \t\tsolute.AddKgHaDelta(SoluteSetterType.Other, values.ToArray());\n\t\t        \telse\n\t\t        \t\tsolute.SetKgHa(SoluteSetterType.Other, values.ToArray());\n\t\t        \t\n\t\t        \tSoluteAdded = solute.kgha.Sum();\n    \t    \t}\n        \t}\n\t\t}\n    }\n}\n",
          "Parameters": [
            {
              "Key": "DateCsvString",
              "Value": "1/01/2000"
            },
            {
              "Key": "ValueCsvString",
              "Value": "100,0,0,0,0,0,0,0"
            },
            {
              "Key": "SoluteName",
              "Value": "Br"
            },
            {
              "Key": "SetAdd",
              "Value": "Set"
            }
          ],
          "Name": "SoluteInitialise",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "// This script calculates a *WaterBalance* term (output) that adds together the water balance\n// water entering the system (e.g. rain, irrigation) and subtracts the water\n// leaving the system (e.g. runoff, drainage, evaporation, plant water uptake). If mass balance\n// is maintained, the *WaterBalance* variable should always be zero.   \n\n\n\n\nusing Models.Climate;\nusing APSIM.Shared.Utilities;\nusing Models.Soils.Nutrients;\nusing Models.Soils;\nusing Models.PMF;\nusing Models.Core;\nusing System.Xml.Serialization;\nusing System;\nusing System.Linq;\nusing Models.AgPasture;\nusing Models.Interfaces;\n\nnamespace Models\n{\n    [Serializable] \n    [System.Xml.Serialization.XmlInclude(typeof(Model))]\n    public class Script : Model\n    {\n        [Link] Clock clock;\n        [Link] ISummary summary;\n        [Link] IWeather weather;\n        [Link] Irrigation irrigation;\n        [Link] private ISoilWater waterBalance;\n        [Link] private IPlant[] plants;\n\n  \n                                [Separator(\"This manager checks that water in the simulation balances - that all inputs are accounted for as storage or losses. If the water balance exceeds (high or low) the tolerance then the simulation is crashed.\")]\n                                \n                                [Description(\"What water mass balance error is tolerable in the cumulative water balance? (mm /year) (suggest substantially < 1 mm /year)\")] public double WBTolerance { get; set; }\n                                \n                                \n        public double WaterBalanceCumulative  { get; set; }\n        public double WaterBalanceToday  { get; set; }\n\n        public double SoilWaterAtInitialisation  { get; set; }\n        public double SoilWaterYesterday  { get; set; }\n                                public double SoilWaterNow  { get; set; }\n\n                                public double PlantWaterUptake { get; set; }\n\n        public double WaterAddedToday  { get; set; }\n        public double WaterRemovedToday  { get; set; }\n        public double WaterAddedCumulative  { get; set; }\n        public double WaterRemovedCumulative  { get; set; }\n        \n        public double WBCheck { get; set; }\n        \n\n        [EventSubscribe(\"DoDailyInitialisation\")]\n        private void DoDailyInitialisation(object sender, EventArgs e)\n        {\n               if (clock.Today == clock.StartDate) \n               // capture the water in and on the soil as a starting point\n               // doing this here as need the models to have intialised first\n               {\n                               SoilWaterAtInitialisation = waterBalance.Pond;\n                               for (int i = 0; i < waterBalance.SWmm.Length; i++)\n                                               SoilWaterAtInitialisation += waterBalance.SWmm[i];\n\n                               SoilWaterYesterday = SoilWaterAtInitialisation;                  \n                               WaterAddedCumulative = 0.0;\n                               WaterRemovedCumulative = 0.0;\n                               SoilWaterNow = 0.0;\n               }\n               else\n               {\n                               SoilWaterYesterday = SoilWaterNow;                     // SoilWaterNow holds the value calculated at reporting yesterday\n                               WaterAddedToday = 0.0;\n                               WaterRemovedToday = 0.0;\n               }\n                                }\n\n        [EventSubscribe(\"DoReportCalculations\")]\n        private void DoReportCalculations(object sender, EventArgs e)\n        {\n               // All the WaterBalance variables should be zero. A positive value is a generation of water.\n               SoilWaterNow = waterBalance.Pond;\n               for (int i = 0; i < waterBalance.SWmm.Length; i++)\n                               SoilWaterNow += waterBalance.SWmm[i]; // so all the water stored in or on the soil\n\n               WaterAddedToday = weather.Rain + irrigation.IrrigationApplied;   // Can there be runon? Probably not but this will throw an error if that ever happens\n               WaterAddedCumulative+= WaterAddedToday;\n\n               WaterRemovedToday = waterBalance.Drainage + waterBalance.Es + waterBalance.Runoff + waterBalance.SubsurfaceDrain;\n               PlantWaterUptake = 0.0;\n               foreach (var plant in plants)\n                               PlantWaterUptake += plant.WaterUptake.Sum();\n\n               WaterRemovedToday += PlantWaterUptake;\n               // Need to add subsurface drainage here\n\n               WaterRemovedCumulative += WaterRemovedToday;\n\n               WaterBalanceToday = WaterAddedToday - WaterRemovedToday - (SoilWaterNow - SoilWaterYesterday);\n               WaterBalanceCumulative = WaterAddedCumulative - WaterRemovedCumulative - (SoilWaterNow - SoilWaterAtInitialisation);\n\n               // need to add a warning value and a crash value and make a crash\n               double simTimeYears = (clock.Today - clock.StartDate).Days/365.25;\n               if (simTimeYears > 0.1)\n               {\n                               WBCheck = WaterBalanceCumulative * simTimeYears;\n                               if (WBCheck > WBTolerance * simTimeYears)\n                                               throw new Exception(\"The error in the water balance, \" + WaterBalanceCumulative + \", exceeded the specified tolerance of \" + WBTolerance * simTimeYears + \". There is likely a problem with SWIM or SoilWater.\");\n               }\n                                }\n    }\n}\n",
          "Parameters": [
            {
              "Key": "WBTolerance",
              "Value": "0.01"
            }
          ],
          "Name": "CalculateRollingWaterBalance",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Core;\r\nusing Models.PMF;\r\nusing APSIM.Shared.Utilities;\nusing Models.Utilities;\r\nusing Models.Surface;\r\nusing Models.Functions;\n\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock Clock;\n        [Link(Type = LinkType.Path, Path=\"[Nutrient].FOMLignin.Decomposition.Rate.TF\")] private CERESMineralisationTemperatureFactor TFLignin;\n\t\t[Link(Type = LinkType.Path, Path=\"[Nutrient].FOMCellulose.Decomposition.Rate.TF\")] private CERESMineralisationTemperatureFactor TFCellulose;\n\t\t[Link(Type = LinkType.Path, Path=\"[Nutrient].FOMCarbohydrate.Decomposition.Rate.TF\")] private CERESMineralisationTemperatureFactor TFCarbohydrate;\n\t\t[Link(Type = LinkType.Path, Path=\"[Nutrient].Microbial.Decomposition.Rate.TF\")] private CERESMineralisationTemperatureFactor TFMicrobial;\n\t\t[Link(Type = LinkType.Path, Path=\"[Nutrient].Humic.Decomposition.Rate.TF\")] private CERESMineralisationTemperatureFactor TFHumic;\n\t\t[Link(Type = LinkType.Path, Path=\"[Nutrient].Nitrification.Rate.CERESMineralisationTemperatureFactor\")] private CERESMineralisationTemperatureFactor TFNitrification;\n\t\t\n        [Separator(\"WARNING - use with caution and considerable testing. Changing these values invalidates the existing testing in APSIM\")]\n\t\t\n        [Description(\"New base temperature for decomposition (oC)\")] public double BaseTemp { get; set; }\n        [Description(\"New optimum temperature for decomposition (oC)\")] public double OptTemp { get; set; }\n        \n        \n        [Separator(\"To which soil organic matter fractions should the above values apply?\")]\n\n        [Description(\"Apply these to the FOM Lignin fraction?\")] public bool DoLignin { get; set; }\n        [Description(\"Apply these to the FOM Cellulose fraction?\")] public bool DoCellulose { get; set; }\n        [Description(\"Apply these to the FOM Carbohydrate fraction?\")] public bool DoCarbohydrate { get; set; }\n        [Description(\"Apply these to the Microbial fraction?\")] public bool DoMicrobial { get; set; }\n        [Description(\"Apply these to the Humic fraction?\")] public bool DoHumic { get; set; }\n        [Description(\"Apply these to the Nitrification rate?\")] public bool DoNitrification { get; set; }\n\n\n\r\n        [EventSubscribe(\"StartOfSimulation\")]\r\n        private void OnStartOfSimulation(object sender, EventArgs e)\r\n        {\n   \t\t\tif (DoLignin)\n   \t\t\t{\n   \t\t\t\tTFLignin.MineralisationSTBase = BaseTemp;\n        \t\tTFLignin.MineralisationSTOpt = OptTemp;\n        \t}\n\n   \t\t\tif (DoCellulose)\n   \t\t\t{\n   \t\t\t\tTFCellulose.MineralisationSTBase = BaseTemp;\n        \t\tTFCellulose.MineralisationSTOpt = OptTemp;\n        \t}\n\n   \t\t\tif (DoCarbohydrate)\n   \t\t\t{\n   \t\t\t\tTFCarbohydrate.MineralisationSTBase = BaseTemp;\n        \t\tTFCarbohydrate.MineralisationSTOpt = OptTemp;\n        \t}\n\n   \t\t\tif (DoMicrobial)\n   \t\t\t{\n   \t\t\t\tTFMicrobial.MineralisationSTBase = BaseTemp;\n        \t\tTFMicrobial.MineralisationSTOpt = OptTemp;\n        \t}\n\n   \t\t\tif (DoHumic)\n   \t\t\t{\n   \t\t\t\tTFHumic.MineralisationSTBase = BaseTemp;\n        \t\tTFHumic.MineralisationSTOpt = OptTemp;\n        \t}\n\n   \t\t\tif (DoNitrification)\n   \t\t\t{\n   \t\t\t\tTFNitrification.MineralisationSTBase = BaseTemp;\n        \t\tTFNitrification.MineralisationSTOpt = OptTemp;\n        \t}\n\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "BaseTemp",
              "Value": "0"
            },
            {
              "Key": "OptTemp",
              "Value": "32"
            },
            {
              "Key": "DoLignin",
              "Value": "True"
            },
            {
              "Key": "DoCellulose",
              "Value": "True"
            },
            {
              "Key": "DoCarbohydrate",
              "Value": "True"
            },
            {
              "Key": "DoMicrobial",
              "Value": "True"
            },
            {
              "Key": "DoHumic",
              "Value": "True"
            },
            {
              "Key": "DoNitrification",
              "Value": "True"
            }
          ],
          "Name": "ModifyNutrientSoilTempFunctions",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        }
      ],
      "Enabled": true,
      "ReadOnly": false
    },
    {
      "$type": "Models.Core.Folder, Models",
      "ShowInDocs": false,
      "GraphsPerPage": 6,
      "Name": "Pasture Graze Stock",
      "ResourceName": null,
      "Children": [
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Core;\r\nusing Models.PMF;\r\nusing APSIM.Shared.Utilities;\r\nusing Models.Surface;\r\n\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock Clock;\r\n        [Link] SurfaceOrganicMatter SOM;\r\n        \r\n        [Separator(\"Add animal manure to surface organic matter\")]\r\n        [Description(\"Date to add animal manure\")]\r\n        public string ManureDate { get; set; }\r\n        \r\n        [Description(\"Amount of animal manure to Add (kg/ha)\")]\r\n        public double Amount { get; set; }\r\n\r\n        [Description(\"Manure dry matter proportion (g/g)\")]\r\n        public double MDMP { get; set; }\r\n\r\n        [Description(\"Manure N concentration in dry matter (g/g)\")]\r\n        public double NConc { get; set; }\r\n\r\n\r\n\r\n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n            if (DateUtilities.WithinDates(ManureDate, Clock.Today, ManureDate))\r\n            {\r\n                SOM.FractionFaecesAdded = MDMP;\r\n                AddFaecesType Data = new AddFaecesType();\r\n                Data.OMWeight = Amount;\r\n                Data.OMN = Amount * NConc;\r\n                SOM.AddFaeces(Data);\r\n            }\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "ManureDate",
              "Value": "1-sep"
            },
            {
              "Key": "Amount",
              "Value": "1000"
            },
            {
              "Key": "MDMP",
              "Value": "1"
            },
            {
              "Key": "NConc",
              "Value": "0.05"
            }
          ],
          "Name": "AddManure on a fixed date",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Interfaces;\nusing APSIM.Shared.Utilities;\nusing Models.PMF;\nusing Models.Soils;\nusing Models.Core;\nusing System;\nusing System.Linq;\nusing Models.Soils.Nutrients;\n\nnamespace Models\n{\n    [Serializable]\n    public class Script : Model\n    {\n        [Link] private Clock clock;\n        [Link] private Fertiliser fertiliser;\n        [Link] private ISummary summary;\n        [Link] private Soil soil;\n        private Nutrient nutrient;\n        private SoilNitrogen soilN;\n        [Link]\n        private IPhysical soilPhysical;\n\n\n        [Separator(\"Urine will be deposited on the date(s) below\")]\n        [Description(\"Apply urine on the same day(s) each year? If no, then must include the year of appliaction below\")]\n        public bool EachYear { get; set; }\n\n        [Description(\"Dates for one or more urine depositions (dd-mmm or dd-mmm-yyyy) as a list with a comma between dates\")]\n        public string[] Dates { get; set; }\n\n        [Separator(\"Urine deposition details\")]\n        [Description(\"Depth to which the urine should penetrate (mm)\")]\n        public double Depth { get; set; }\n\n        [Description(\"Amount of urine to apply (kg N /ha) for each deposition\")]\n        public double Amount { get; set; }\n\n\n        [EventSubscribe(\"StartOfSimulation\")]\n        private void FindSoilNOrNutrient(object sender, EventArgs e)\n        {\n            nutrient = this.FindInScope<Nutrient>() as Nutrient;\n            soilN = this.FindInScope<SoilNitrogen>() as SoilNitrogen;\n\n            if (nutrient == null && soilN == null)\n                throw new Exception(string.Format(\"Error in script {0}: Unable to find nutrient or soilN.\", Name));\n        }\n\n        [EventSubscribe(\"DoManagement\")]\n        private void OnDoManagement(object sender, EventArgs e)\n        {\n            if (OnDepositionDate())\n            {\n                double[] weights = GetLayerWeights();\n                            double cumulativeDepth = 0.0;\n                            Fertiliser.Types FertiliserType = Fertiliser.Types.UreaN;\n                \n                for (int i = 0; i < soilPhysical.Thickness.Length; i++)\n               {\n                                cumulativeDepth += soilPhysical.Thickness[i];\n                                if (weights[i] > 0.0)\n                                                fertiliser.Apply(Amount * weights[i], FertiliserType, cumulativeDepth - (soilPhysical.Thickness[i] / 2.0) );  \n                            }\n                            summary.WriteMessage(this, \"Urine deposition of \" + Amount + \" kg N /ha to a depth of \" + Depth + \" mm\", MessageType.Information); \n            }\n        }\n\n        /// <summary>Checks if today's date is one of the specified fertiliser application dates.</summary>\n        private bool OnDepositionDate()\n        {\n            if (EachYear)\n                return Dates.Any(d => DateUtilities.DatesEqual(d, clock.Today));\n            \n            DateTime[] dates = Dates.Select(d => DateTime.ParseExact(d, \"d-MMM-yyyy\", null)).ToArray();\n            return dates.Any(d => SameDate(d, clock.Today));\n        }\n\n        private double[] GetLayerWeights()\n        {\n            double[] weights = new double[soilPhysical.Thickness.Length];\n            double cumDepth = 0;\n            for (int i = 0; i < soilPhysical.Thickness.Length; i++)\n            {\n                cumDepth += soilPhysical.Thickness[i];\n                if (cumDepth < Depth)\n                    weights[i] = soilPhysical.Thickness[i] / Depth;    // all the layer is within the deposition depth\n                else if (cumDepth - soilPhysical.Thickness[i] <= Depth)\n                    weights[i] = (Depth - (cumDepth - soilPhysical.Thickness[i])) / Depth;\n                else\n                    weights[i] = 0;\n            }\n            return weights;\n        }\n\n        private bool SameDate(DateTime d1, DateTime d2)\n        {\n            return d1.Year == d2.Year && d1.DayOfYear == d2.DayOfYear;\n        }\n    }\n}\n",
          "Parameters": [
            {
              "Key": "Amount",
              "Value": "1000"
            },
            {
              "Key": "EachYear",
              "Value": "False"
            },
            {
              "Key": "Dates",
              "Value": ""
            },
            {
              "Key": "Depth",
              "Value": "0"
            }
          ],
          "Name": "Urine deposition on fixed dates",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        }
      ],
      "Enabled": true,
      "ReadOnly": false
    },
    {
      "$type": "Models.Core.Folder, Models",
      "ShowInDocs": false,
      "GraphsPerPage": 6,
      "Name": "Other",
      "ResourceName": null,
      "Children": [
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils.Nutrients;\r\nusing APSIM.Shared.Utilities;\r\nusing Models.Surface;\r\nusing Models.Utilities;\r\nusing Models.Soils.Nutrients;\r\nusing Models.Soils;\r\nusing Models.PMF;\r\nusing Models.Core;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Interfaces;\r\n\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] private Plant Wheat;\r\n        [Link] private ISoilWater SoilWater;\r\n        [Link] private Nutrient nutrient;\r\n        [Link] private SurfaceOrganicMatter SOM;\r\n        [Link] private Summary Summary;\r\n\r\n        [Description(\"Reset Water? (Yes or No)\")]\r\n        public string ResetWater {get;set;}\r\n\r\n        [Description(\"Reset Soil Nutrients? (Yes or No)\")]\r\n        public string ResetNutrients {get;set;}\r\n\r\n        [Description(\"Reset Surface Organic Matter? (Yes or No)\")]\r\n        public string ResetSOM {get;set;}\r\n\r\n        [EventSubscribe(\"Sowing\")]\r\n        private void OnSowing(object sender, EventArgs e)\r\n        {\r\n            if (ResetWater == \"Yes\")\r\n            {\r\n                Summary.WriteMessage(this, \"Reset Water\", MessageType.Diagnostic);\r\n                SoilWater.Reset();\r\n            }\r\n            if (ResetNutrients == \"Yes\")\r\n            {\r\n                Summary.WriteMessage(this, \"Reset Nutrients\", MessageType.Diagnostic);\r\n                nutrient.Reset();\r\n            }\r\n            if (ResetSOM == \"Yes\")\r\n            {\r\n                Summary.WriteMessage(this, \"Reset Surface OM\", MessageType.Diagnostic);\r\n                SOM.Reset();\r\n            }\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "ResetWater",
              "Value": "Yes"
            },
            {
              "Key": "ResetNutrients",
              "Value": "Yes"
            },
            {
              "Key": "ResetSOM",
              "Value": "Yes"
            }
          ],
          "Name": "Reset on sowing",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils.Nutrients;\r\nusing APSIM.Shared.Utilities;\r\nusing Models.Surface;\r\nusing Models.Utilities;\r\nusing Models.Soils.Nutrients;\r\nusing Models.Soils;\r\nusing Models.PMF;\r\nusing Models.Core;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Interfaces;\r\n\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] private Clock Clock;\r\n        [Link] private Plant Wheat;\r\n        [Link] private ISoilWater SoilWater;\r\n        [Link] private Nutrient nutrient;\r\n        [Link] private SurfaceOrganicMatter SOM;\r\n        [Link] private Summary Summary;\r\n\r\n        [Description(\"Date to reset on:\")]\r\n        public string ResetDate {get;set;}\r\n\r\n        [Description(\"Reset Water? (Yes or No)\")]\r\n        public string ResetWater {get;set;}\r\n\r\n        [Description(\"Reset Soil Nutrients ? (Yes or No)\")]\r\n        public string ResetNutrients {get;set;}\r\n\r\n        [Description(\"Reset Surface Organic Matter? (Yes or No)\")]\r\n        public string ResetSOM {get;set;}\r\n\r\n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnDoManagement(object sender, EventArgs e)\r\n        {\r\n            if (DateUtilities.WithinDates(ResetDate, Clock.Today, ResetDate))\r\n            {\r\n                if (ResetWater == \"Yes\")\r\n                {\r\n                    Summary.WriteMessage(this, \"Reset Water\", MessageType.Diagnostic);\r\n                    SoilWater.Reset();\r\n                }\r\n                if (ResetNutrients == \"Yes\")\r\n                {\r\n                    Summary.WriteMessage(this, \"Reset Nitrogen\", MessageType.Diagnostic);\r\n                    nutrient.Reset();\r\n                }\r\n                if (ResetSOM == \"Yes\")\r\n                {\r\n                    Summary.WriteMessage(this, \"Reset Surface OM\", MessageType.Diagnostic);\r\n                    SOM.Reset();\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "ResetDate",
              "Value": "1-Jan"
            },
            {
              "Key": "ResetWater",
              "Value": "Yes"
            },
            {
              "Key": "ResetNutrients",
              "Value": "Yes"
            },
            {
              "Key": "ResetSOM",
              "Value": "Yes"
            }
          ],
          "Name": "Reset on date",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\r\nusing System;\r\nusing System.Linq;\r\nusing Models.Core;\r\nusing Models.PMF;\r\nusing APSIM.Shared.Utilities;\r\n\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock Clock;\r\n        [Link] Fertiliser Fertiliser;\r\n        [Link] Summary Summary;\r\n        \r\n        [Description(\"Country\")]\r\n        public string Country { get; set; }\r\n\r\n        [Description(\"State\")]\r\n        public string State { get; set; }\r\n\r\n        [Description(\"Region\")]\r\n        public string Region { get; set; }\r\n\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "Country",
              "Value": ""
            },
            {
              "Key": "State",
              "Value": ""
            },
            {
              "Key": "Region",
              "Value": ""
            }
          ],
          "Name": "LocationInfo",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        },
        {
          "$type": "Models.Manager, Models",
          "Code": "using Models.Soils;\r\nusing System.Diagnostics;\r\nusing System.Collections.Generic;\r\nusing System.IO;\r\nusing System.Data;\r\nusing System.Linq;\r\nusing System;\r\nusing Models.Interfaces;\r\nusing Models.Core;\r\nusing Models.PMF;\r\nusing APSIM.Shared.Utilities;\r\nnamespace Models\r\n{\r\n    [Serializable]\r\n    [System.Xml.Serialization.XmlInclude(typeof(Model))]\r\n    public class Script : Model\r\n    {\r\n        [Link] Clock clock;\r\n        [Link] IWeather weather;\r\n        [Link] Simulation simulation;\n        [Link] Plant plant;\n        [Link] Zone zone;\n        [Link] Summary summary;\r\n        \r\n        private DataTable data;\n        \n        [Separator(\"To use you will need an excel file with two columns named 'date' and 'a'.\")]\r\n\r\n        [Description(\"Name of file containing weather data to patch:\")]\r\n        public string PatchFileName { get; set; }\n        \n        [Description(\"Sheet name:\")]\n        public string SheetName {get;set;}\n       \r\n\n\t\t//Name of reportable value.\r\n        public double DataValue{ get; set; }\r\n        \r\n        [EventSubscribe(\"StartOfSimulation\")]\r\n        private void OnStartOfSimulation(object sender, EventArgs e)\r\n        {\r\n            // Ensure filename is relative to the directory where the .apsimx file is located.\r\n            string fullFileName = PathUtilities.GetAbsolutePath(PatchFileName, simulation.FileName);\r\n        \r\n            // Read in data.\n            data = ExcelUtilities.ReadExcelFileData(fullFileName, SheetName, true); \r\n        }\n        \n        \n        [EventSubscribe(\"DoManagement\")]\r\n        private void OnSowing(object sender, EventArgs e)\r\n        {\n        \tDataValue = GetValue(clock.Today.ToString(\"MM/dd/yyyy\"));\n        }\n\n        \n        private double GetValue(string searchDate)\n        {\n        \t\n        \tDataView view =  new DataView(data);\n        \t// Here we are querying the dataView for a matching date column with the date we selected.\n        \tview.RowFilter = $\"date = #{searchDate}#\";\n        \t// Check if any matching results are found.\n        \tif (view.Count == 0)\n        \t\tthrow new Exception(\"Can't find date = \" + searchDate);\n        \telse \n        \t\t// Here we are converting the value to a number.\n        \t\t// Modify this to search for name of the column you want the value from. \n        \t\t// Here it is named \"a\".\n        \t\treturn Convert.ToDouble(view[0][\"a\"]);\n            \n        }\r\n\r\n       \r\n\r\n    }\r\n}\r\n",
          "Parameters": [
            {
              "Key": "PatchFileName",
              "Value": "datevalues.xlsx"
            },
            {
              "Key": "SheetName",
              "Value": "Sheet1"
            }
          ],
          "Name": "ValueFromExcel",
          "ResourceName": null,
          "Children": [],
          "Enabled": true,
          "ReadOnly": false
        }
      ],
      "Enabled": true,
      "ReadOnly": false
    }
  ],
  "Enabled": true,
  "ReadOnly": false
}